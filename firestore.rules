rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user has spherepay.co email domain
    function isSpherepayUser() {
      return isAuthenticated() &&
             request.auth.token.email != null &&
             request.auth.token.email.matches('.*@spherepay[.]co$');
    }

    // Helper function to validate string fields
    function isValidString(field) {
      return field is string && field.size() > 0 && field.size() < 1000;
    }

    // Helper function to validate that required fields exist
    function hasRequiredClientFields() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'type']) &&
             isValidString(data.name) &&
             data.type in ['Aggregator', 'Sub-merchant'];
    }

    function hasRequiredReferrerFields() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'type']) &&
             isValidString(data.name);
    }

    function hasRequiredReferralFields() {
      let data = request.resource.data;
      return data.keys().hasAll(['referredCompany', 'status']) &&
             isValidString(data.referredCompany);
    }

    // Clients collection - only spherepay.co users can read/write
    match /clients/{clientId} {
      allow read: if isSpherepayUser();
      allow create: if isSpherepayUser() && hasRequiredClientFields();
      allow update: if isSpherepayUser() && hasRequiredClientFields();
      allow delete: if isSpherepayUser();
    }

    // Referrers collection - only spherepay.co users can read/write
    match /referrers/{referrerId} {
      allow read: if isSpherepayUser();
      allow create: if isSpherepayUser() && hasRequiredReferrerFields();
      allow update: if isSpherepayUser() && hasRequiredReferrerFields();
      allow delete: if isSpherepayUser();
    }

    // Referrals collection - only spherepay.co users can read/write
    match /referrals/{referralId} {
      allow read: if isSpherepayUser();
      allow create: if isSpherepayUser() && hasRequiredReferralFields();
      allow update: if isSpherepayUser() && hasRequiredReferralFields();
      allow delete: if isSpherepayUser();
    }

    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
