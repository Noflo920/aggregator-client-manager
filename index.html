<!DOCTYPE html> <!-- v8 - SpherePay Brand -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpherePay ‚Ä¢ Client Manager</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='47' fill='white'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232970FF'/%3E%3Cstop offset='100%25' stop-color='%23DDEDFF'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M50 5C25.1 5 5 25.1 5 50s20.1 45 45 45 45-20.1 45-45S74.9 5 50 5zm42 47c-1.4 2.5-3.3 5-5.6 7.5-7 7.5-17.5 13.9-29.5 18.3-9.4 3.4-19 5.2-27.7 5.3-6.1 0-11.4-.9-16.3-3.4 8.2 9.9 20.6 16.2 34.5 16.2 25.2 0 45.7-20 45.7-45.1 0-.3 0-.6 0-.8zM50 8c24.7 0 44.7 19.9 44.7 44.3 0 5.2-1 10.2-2.6 14.9-1.2 3.4-4.1 6-8.2 8-4 1.8-9.2 2.8-15.1 2.8-7.8 0-16.7-1.6-26-5.9-11.6-4.2-21.3-10.4-27.5-17-5.7-6.6-8.4-13.5-6.3-20.9C15.6 18.5 31.8 8.5 50.8 8H50z' fill='url(%23g)'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: '#2970FF',
              'brand-light': '#84ADFF',
              'brand-pale': '#DDEDFF',
              surface: '#18181b',
              base: '#09090b',
              border: '#27272a',
              muted: '#71717a'
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            borderRadius: {
              'none': '0',
            }
          }
        }
      }
    </script>
    <style>
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* ============================================ */
        /* BASE / LIGHT MODE */
        /* ============================================ */
        body {
          font-family: 'Inter', system-ui, sans-serif;
          background: #f8fafc;
          min-height: 100vh;
          color: #1e293b;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .geo-bg { background: #f8fafc; }

        /* Header - Light */
        .glass-header { background: white; border-bottom: 1px solid #e2e8f0; }

        /* Cards - Light */
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; }
        .stat-card {
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          transition: all 0.2s ease;
        }
        .stat-card:hover {
          border-color: #2970FF;
          box-shadow: 0 4px 12px rgba(41, 112, 255, 0.1);
        }

        /* Primary button */
        .btn-primary {
          background: #2970FF;
          color: #fff;
          font-weight: 600;
          border-radius: 6px;
          transition: all 0.2s ease;
        }
        .btn-primary:hover {
          background: #1a5fe6;
          box-shadow: 0 4px 12px rgba(41, 112, 255, 0.3);
        }

        /* Filter pills - Light */
        .filter-pill {
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 6px;
          transition: all 0.15s ease;
          color: #64748b;
        }
        .filter-pill:hover { border-color: #cbd5e1; background: #f8fafc; }
        .filter-pill.active { background: #2970FF; border-color: #2970FF; color: white; }

        /* Table - Light */
        tbody tr { background: white; border-bottom: 1px solid #f1f5f9; }
        tbody tr:hover { background: #f8fafc !important; }
        thead { position: sticky; top: 0; z-index: 10; background: white; }
        thead th { border-bottom: 1px solid #e2e8f0; color: #64748b; font-weight: 500; }

        /* Inputs - Light */
        input, select, textarea {
          background: white;
          border: 1px solid #e2e8f0;
          color: #1e293b;
          border-radius: 6px;
        }
        input::placeholder { color: #94a3b8; }
        input:focus, select:focus, textarea:focus {
          border-color: #2970FF;
          outline: none;
          box-shadow: 0 0 0 3px rgba(41, 112, 255, 0.1);
        }

        /* Scrollbar - Light */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2970FF; }

        /* Animations */
        html { scroll-behavior: smooth; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-slide-up { animation: slideUp 0.2s ease-out; }
        .animate-scale-in { animation: scaleIn 0.15s ease-out; }

        /* Accent line */
        .accent-line { height: 3px; background: linear-gradient(90deg, #2970FF, #84ADFF); }

        /* ============================================ */
        /* DARK MODE */
        /* ============================================ */
        .dark { background: #09090b; color: #e4e4e7; }
        .dark body { background: #09090b; color: #e4e4e7; }
        .dark .geo-bg { background: #09090b; }
        .dark .glass-header { background: #0f0f11; border-color: #27272a; }
        .dark .glass-card { background: #18181b; border-color: #27272a; }
        .dark .stat-card { background: #18181b; border-color: #27272a; }
        .dark .stat-card:hover { border-color: #2970FF; box-shadow: 0 4px 20px rgba(41, 112, 255, 0.15); }
        .dark .filter-pill { background: #18181b; border-color: #27272a; color: #a1a1aa; }
        .dark .filter-pill:hover { border-color: #3f3f46; background: #27272a; }
        .dark tbody tr { background: #18181b; border-color: #27272a; }
        .dark tbody tr:hover { background: #27272a !important; }
        .dark thead { background: #0f0f11; }
        .dark thead th { color: #71717a; border-color: #27272a; }
        .dark input, .dark select, .dark textarea { background: #18181b; border-color: #27272a; color: #fafafa; }
        .dark input::placeholder { color: #52525b; }
        .dark ::-webkit-scrollbar-track { background: #18181b; }
        .dark ::-webkit-scrollbar-thumb { background: #3f3f46; }

        /* Dark mode logo visibility */
        .dark .logo-dark { display: none; }
        .dark .logo-light { display: block; }

        /* Kanban styles */
        .kanban-column { min-height: 400px; background: #18181b; border: 1px solid #27272a; }
        .kanban-card { cursor: grab; background: #0c0c0e; border: 1px solid #27272a; border-radius: 0; }
        .kanban-card:active { cursor: grabbing; }
        .kanban-card:hover { border-color: #2970FF; }

        /* Status badges */
        .status-badge {
          border-radius: 0;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          font-size: 10px;
        }

        /* Accent line - SpherePay blue gradient */
        @keyframes accentPulse {
          0%, 100% { opacity: 0.5; }
          50% { opacity: 1; }
        }
        .accent-line {
          height: 2px;
          background: linear-gradient(90deg, transparent, #2970FF, #84ADFF, transparent);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      // Initialize Firebase before Babel script
      const firebaseConfig = {
        apiKey: "AIzaSyCCP7_wPzqTwUnUwNXfaWvBHAU9EtAPXao",
        authDomain: "aggregator-client-manager.firebaseapp.com",
        projectId: "aggregator-client-manager",
        storageBucket: "aggregator-client-manager.firebasestorage.app",
        messagingSenderId: "606375112772",
        appId: "1:606375112772:web:a4a8d5a49e995882300c11",
        measurementId: "G-6NEE7RTMHE"
      };
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      window.auth = firebase.auth();
      window.googleProvider = new firebase.auth.GoogleAuthProvider();
      // Restrict to spherepay.co domain
      window.googleProvider.setCustomParameters({
        hd: 'spherepay.co'
      });

      // ============================================
      // GOOGLE SHEETS BACKUP INTEGRATION
      // ============================================
      // To enable: paste your Apps Script Web App URL below
      const GOOGLE_SHEETS_WEBHOOK_URL = '';

      window.syncToGoogleSheets = async function(action, sheetTab, rowData) {
        if (!GOOGLE_SHEETS_WEBHOOK_URL) return { success: false, reason: 'not_configured' };
        try {
          await fetch(GOOGLE_SHEETS_WEBHOOK_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, sheet: sheetTab, data: rowData, timestamp: new Date().toISOString() })
          });
          return { success: true };
        } catch (err) {
          console.warn('Google Sheets sync failed:', err);
          return { success: false, error: err };
        }
      };
      window.isGoogleSheetsConfigured = () => !!GOOGLE_SHEETS_WEBHOOK_URL;

      /*
      GOOGLE APPS SCRIPT CODE - Deploy as Web App:

      function doPost(e) {
        var sheet = SpreadsheetApp.getActiveSpreadsheet();
        var data = JSON.parse(e.postData.contents);
        var tab = sheet.getSheetByName(data.sheet) || sheet.insertSheet(data.sheet);
        if (tab.getLastRow() === 0) {
          if (data.sheet === 'Clients') tab.appendRow(['Timestamp','Action','Name','Type','KYB Status','Flow of Funds','Corridors','Volume','Sumsub','Notes','Parent','ID']);
          else if (data.sheet === 'Referrals') tab.appendRow(['Timestamp','Action','Client','Referrer','Status','Currencies','Notes','ID']);
          else if (data.sheet === 'Partners') tab.appendRow(['Timestamp','Action','Name','Type','Email','Fee Split','Notes','ID']);
        }
        var d = data.data, t = data.timestamp, a = data.action;
        if (data.sheet === 'Clients') tab.appendRow([t,a,d.name||'',d.type||'',d.kybStatus||'',d.inFlowOfFunds?'Yes':'No',JSON.stringify(d.corridors||[]),d.totalVolume||'',d.sumsubLink||'',d.notes||'',d.parentAggregatorId||'',d.id||'']);
        else if (data.sheet === 'Referrals') tab.appendRow([t,a,d.referredCompany||'',d.referrerName||'',d.status||'',JSON.stringify(d.currencies||[]),d.notes||'',d.id||'']);
        else if (data.sheet === 'Partners') tab.appendRow([t,a,d.name||'',d.type||'',d.contactEmail||'',(d.feeSplitPercentage||0)+'%',d.notes||'',d.id||'']);
        return ContentService.createTextOutput(JSON.stringify({status:'ok'})).setMimeType(ContentService.MimeType.JSON);
      }
      function doGet(e) { return ContentService.createTextOutput('Google Sheets Sync is running.'); }
      */
    </script>
    <script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef } = React;

// Debounce hook
function useDebounce(value, delay) {
  const [debouncedValue, setDebouncedValue] = useState(value);
  useEffect(() => {
    const handler = setTimeout(() => setDebouncedValue(value), delay);
    return () => clearTimeout(handler);
  }, [value, delay]);
  return debouncedValue;
}
const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } = window.Recharts;

// Firebase references
const db = window.db;
const auth = window.auth;
const googleProvider = window.googleProvider;

// Allowed email domain for authentication
const ALLOWED_DOMAIN = 'spherepay.co';

// Login Component
function LoginScreen({ onLogin }) {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  const handleGoogleLogin = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const result = await auth.signInWithPopup(googleProvider);
      const user = result.user;

      // Verify email domain
      const emailDomain = user.email.split('@')[1];
      if (emailDomain !== ALLOWED_DOMAIN) {
        await auth.signOut();
        setError(`Access restricted to @${ALLOWED_DOMAIN} accounts only.`);
        setIsLoading(false);
        return;
      }

      onLogin(user);
    } catch (err) {
      console.error('Login error:', err);
      if (err.code === 'auth/popup-closed-by-user') {
        setError('Login cancelled. Please try again.');
      } else if (err.code === 'auth/unauthorized-domain') {
        setError('This domain is not authorized. Please contact support.');
      } else {
        setError(err.message || 'Failed to sign in. Please try again.');
      }
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen geo-bg flex items-center justify-center p-4">
      <div className="bg-[#18181b] border border-[#27272a] max-w-md w-full p-8">
        {/* Accent line */}
        <div className="h-1 bg-gradient-to-r from-[#2970FF] to-[#84ADFF] w-20 mb-8"></div>
        <div className="mb-8">
          <img
            src="https://cdn.prod.website-files.com/6867d3933e172481e1e652b1/6976787f7e997eae28421e33_SpherePay_Light.svg"
            alt="SpherePay"
            className="h-10 mb-6"
          />
          <p className="text-[10px] text-[#84ADFF] font-bold tracking-[0.2em] uppercase">Client Manager</p>
        </div>

        {error && (
          <div className="mb-6 p-4 bg-red-500/10 border border-red-500/30 text-red-400 text-sm">
            {error}
          </div>
        )}

        <button
          onClick={handleGoogleLogin}
          disabled={isLoading}
          className="w-full flex items-center justify-center gap-3 px-4 py-3.5 bg-[#27272a] border border-[#3f3f46] text-white text-sm font-bold uppercase tracking-wider hover:border-[#2970FF] hover:bg-[#27272a] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isLoading ? (
            <div className="w-5 h-5 border-2 border-[#3f3f46] border-t-[#2970FF] animate-spin"></div>
          ) : (
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
          )}
          <span>
            {isLoading ? 'Signing in...' : 'Continue with Google'}
          </span>
        </button>

        <p className="mt-6 text-center text-[10px] text-[#52525b] font-bold tracking-wider uppercase">
          Access restricted to @spherepay.co accounts
        </p>
      </div>
    </div>
  );
}

// Auth wrapper component
function AuthWrapper({ children }) {
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged((user) => {
      if (user) {
        // Verify domain on auth state change
        const emailDomain = user.email.split('@')[1];
        if (emailDomain === ALLOWED_DOMAIN) {
          setUser(user);
        } else {
          auth.signOut();
          setUser(null);
        }
      } else {
        setUser(null);
      }
      setAuthLoading(false);
    });

    return () => unsubscribe();
  }, []);

  if (authLoading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600 font-medium">Loading...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return <LoginScreen onLogin={setUser} />;
  }

  return children(user);
}

// Firestore utility functions
const firestoreUtils = {
  // Subscribe to a collection and return unsubscribe function
  subscribe: (collection, callback) => {
    return db.collection(collection).onSnapshot((snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      callback(data);
    }, (error) => {
      console.error(`Error subscribing to ${collection}:`, error);
    });
  },

  // Save/update a document
  save: async (collection, data) => {
    try {
      if (data.id) {
        // Update existing document
        const { id, ...docData } = data;
        await db.collection(collection).doc(id).set(docData);
      } else {
        // Create new document with auto-generated ID
        const docRef = await db.collection(collection).add(data);
        return docRef.id;
      }
    } catch (error) {
      console.error(`Error saving to ${collection}:`, error);
      throw error;
    }
  },

  // Delete a document
  delete: async (collection, id) => {
    try {
      await db.collection(collection).doc(id).delete();
    } catch (error) {
      console.error(`Error deleting from ${collection}:`, error);
      throw error;
    }
  },

  // Batch update multiple documents
  batchUpdate: async (collection, updates) => {
    try {
      const batch = db.batch();
      updates.forEach(({ id, data }) => {
        const ref = db.collection(collection).doc(id);
        batch.set(ref, data);
      });
      await batch.commit();
    } catch (error) {
      console.error(`Error batch updating ${collection}:`, error);
      throw error;
    }
  }
};

// Legacy storage utility (fallback)
const storage = {
  get: (key, defaultValue) => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch {
      return defaultValue;
    }
  },
  set: (key, value) => {
    try {
      window.localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      console.error('Storage error:', e);
    }
  }
};

// Constants
const CURRENCIES = ['USD', 'EUR', 'International USD', 'BRL'];
const CLIENT_TYPES = ['Aggregator', 'Sub-merchant'];
const KYB_STATUSES = ['Pending', 'In Review', 'Approved', 'Rejected'];
const PRIORITIES = ['High', 'Med', 'Low'];
const REFERRAL_STATUSES = ['Active', 'Pending', 'Inactive'];
const REFERRER_TYPES = ['Partner', 'Client', 'Affiliate'];

const KYB_COLORS = {
  'Pending': { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300' },
  'In Review': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300' },
  'Approved': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' },
  'Rejected': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' }
};

const PRIORITY_COLORS = {
  'High': { bg: 'bg-red-100', text: 'text-red-700' },
  'Med': { bg: 'bg-amber-100', text: 'text-amber-700' },
  'Low': { bg: 'bg-blue-100', text: 'text-blue-700' }
};

const CHART_COLORS = ['#facc15', '#3b82f6', '#22c55e', '#ef4444'];

const REFERRAL_STATUS_COLORS = {
  'Active': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' },
  'Pending': { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300' },
  'Inactive': { bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-300' }
};

// Generate unique ID
const generateId = () => Math.random().toString(36).substr(2, 9);

// Toast Component
function Toast({ message, type, onClose, onUndo }) {
  useEffect(() => {
    if (type !== 'undo') {
      const timer = setTimeout(onClose, 4000);
      return () => clearTimeout(timer);
    }
  }, [onClose, type]);

  const styles = {
    success: 'bg-gradient-to-r from-green-500 to-emerald-600',
    error: 'bg-gradient-to-r from-red-500 to-rose-600',
    info: 'bg-gradient-to-r from-blue-500 to-indigo-600',
    undo: 'bg-gradient-to-r from-slate-700 to-slate-800'
  };
  const icons = {
    success: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
    error: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
    info: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    undo: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
  };

  return (
    <div className={`fixed bottom-4 right-4 ${styles[type] || styles.info} text-white px-5 py-3 rounded-xl shadow-lg z-50 animate-slide-up flex items-center gap-3`}>
      <div className="flex-shrink-0">{icons[type] || icons.info}</div>
      <span className="font-medium">{message}</span>
      {type === 'undo' && onUndo && (
        <button
          onClick={onUndo}
          className="ml-2 px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-semibold transition-colors"
        >
          Undo
        </button>
      )}
      <button onClick={onClose} className="ml-1 p-1 hover:bg-white/20 rounded-lg transition-colors">
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
  );
}

// Client Detail Sidebar Component
function ClientDetailSidebar({ client, onClose, onEdit, onDelete, formatVolume }) {
  if (!client) return null;

  const totalVolume = client.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0);
  const kybColors = {
    'Pending': 'bg-amber-100 text-amber-700 border-amber-200',
    'In Review': 'bg-blue-100 text-blue-700 border-blue-200',
    'Approved': 'bg-emerald-100 text-emerald-700 border-emerald-200',
    'Rejected': 'bg-red-100 text-red-700 border-red-200'
  };

  return (
    <div className="fixed inset-0 z-40 flex justify-end">
      <div className="fixed inset-0 bg-black/80" onClick={onClose}></div>
      <div className="relative w-full max-w-md bg-[#18181b] border-l border-[#27272a] animate-slide-in-right overflow-hidden flex flex-col">
        {/* Header - Sharp style */}
        <div className="bg-[#0c0c0e] text-white px-6 py-5 border-b border-[#27272a]">
          <div className="h-1 bg-gradient-to-r from-[#2970FF] to-[#84ADFF] w-12 mb-4"></div>
          <div className="flex items-start justify-between">
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-2">
                <span className={`px-2 py-1 text-[10px] font-bold uppercase tracking-wider ${client.kybStatus === 'Approved' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : client.kybStatus === 'Pending' ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : client.kybStatus === 'In Review' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`}>
                  {client.kybStatus}
                </span>
                <span className="px-2 py-1 text-[10px] font-bold uppercase tracking-wider bg-[#27272a] text-[#a1a1aa]">{client.type}</span>
              </div>
              <h2 className="text-xl font-black uppercase tracking-tight truncate">{client.name}</h2>
            </div>
            <button onClick={onClose} className="p-2 hover:bg-[#27272a] transition-colors -mr-2">
              <svg className="w-5 h-5 text-[#71717a] hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Volume Card */}
          <div className="bg-slate-800 rounded-xl p-4 text-white">
            <p className="text-slate-300 text-xs uppercase tracking-wider font-semibold mb-1">Total Pipeline</p>
            <p className="text-3xl font-extrabold font-mono">{formatVolume(totalVolume)}</p>
          </div>

          {/* Quick Stats */}
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-gray-50 rounded-xl p-4">
              <p className="text-slate-400 text-xs uppercase tracking-wider font-semibold mb-1">Corridors</p>
              <p className="text-2xl font-bold text-gray-800">{client.corridors.length}</p>
            </div>
            <div className="bg-gray-50 rounded-xl p-4">
              <p className="text-slate-400 text-xs uppercase tracking-wider font-semibold mb-1">Flow of Funds</p>
              <p className="text-2xl font-bold text-gray-800">{client.inFlowOfFunds ? 'Yes' : 'No'}</p>
            </div>
          </div>

          {/* Corridors */}
          <div>
            <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Corridors</h3>
            <div className="space-y-2">
              {client.corridors.map((cor, i) => (
                <div key={i} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                  <div className="flex items-center gap-3">
                    <span className="text-lg">{cor.currency === 'USD' ? 'üá∫üá∏' : cor.currency === 'MXN' ? 'üá≤üáΩ' : cor.currency === 'EUR' ? 'üá™üá∫' : 'üí±'}</span>
                    <span className="font-semibold text-gray-800">{cor.currency}</span>
                  </div>
                  <div className="text-right">
                    <p className="font-mono font-semibold text-gray-800">{formatVolume(cor.expectedVolume || 0)}</p>
                    <p className={`text-xs font-medium ${cor.priority === 'High' ? 'text-red-500' : cor.priority === 'Med' ? 'text-amber-500' : 'text-slate-300'}`}>
                      {cor.priority} Priority
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Sumsub Link */}
          {client.sumsubLink && (
            <div>
              <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">KYB Link</h3>
              <a
                href={client.sumsubLink}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-2 text-slate-600 hover:text-slate-800 font-medium"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                Open in Sumsub
              </a>
            </div>
          )}

          {/* Notes */}
          {client.notes && (
            <div>
              <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">Notes</h3>
              <p className="text-gray-700 bg-gray-50 rounded-xl p-4 whitespace-pre-wrap">{client.notes}</p>
            </div>
          )}
        </div>

        {/* Footer Actions */}
        <div className="border-t bg-gray-50 px-6 py-4 flex gap-3">
          <button
            onClick={() => { onEdit(client); onClose(); }}
            className="flex-1 px-4 py-2.5 bg-slate-700 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-2"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit
          </button>
          <button
            onClick={() => { onDelete(client); onClose(); }}
            className="px-4 py-2.5 border border-red-200 text-red-600 rounded-xl font-semibold hover:bg-red-50 transition-all flex items-center justify-center gap-2"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
          </button>
        </div>
      </div>
      <style>{`
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out; }
      `}</style>
    </div>
  );
}

// Command Palette Component (Cmd+K)
function CommandPalette({ isOpen, onClose, clients, onSelectClient, onAddClient, onNavigate, onExport }) {
  const [query, setQuery] = useState('');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const inputRef = useRef(null);

  const commands = useMemo(() => {
    const items = [];

    // Action commands
    items.push({ type: 'action', icon: '‚ûï', label: 'Add New Client', action: () => { onAddClient(); onClose(); } });
    items.push({ type: 'action', icon: 'üìä', label: 'View Analytics', action: () => { onNavigate('analytics'); onClose(); } });
    items.push({ type: 'action', icon: 'üìã', label: 'View Clients Table', action: () => { onNavigate('clients'); onClose(); } });
    items.push({ type: 'action', icon: 'üìå', label: 'View Kanban Board', action: () => { onNavigate('kanban'); onClose(); } });
    items.push({ type: 'action', icon: 'ü§ù', label: 'View Referrals', action: () => { onNavigate('referrals'); onClose(); } });
    items.push({ type: 'action', icon: 'üë•', label: 'View Partners', action: () => { onNavigate('partners'); onClose(); } });
    items.push({ type: 'action', icon: 'üìÅ', label: 'Export to CSV', action: () => { onExport(); onClose(); } });
    items.push({ type: 'action', icon: 'üåô', label: 'Toggle Dark Mode', action: () => { document.documentElement.classList.toggle('dark'); onClose(); } });

    // Client search
    clients.forEach(client => {
      items.push({
        type: 'client',
        icon: client.type === 'Aggregator' ? 'üè¢' : 'üè™',
        label: client.name,
        subtitle: `${client.type} ‚Ä¢ ${client.kybStatus}`,
        action: () => { onSelectClient(client); onClose(); }
      });
    });

    return items;
  }, [clients, onAddClient, onNavigate, onSelectClient, onExport, onClose]);

  const filteredCommands = useMemo(() => {
    if (!query.trim()) return commands.slice(0, 10);
    const q = query.toLowerCase();
    return commands.filter(cmd =>
      cmd.label.toLowerCase().includes(q) ||
      (cmd.subtitle && cmd.subtitle.toLowerCase().includes(q))
    ).slice(0, 10);
  }, [commands, query]);

  useEffect(() => {
    if (isOpen && inputRef.current) {
      inputRef.current.focus();
      setQuery('');
      setSelectedIndex(0);
    }
  }, [isOpen]);

  useEffect(() => {
    setSelectedIndex(0);
  }, [query]);

  const handleKeyDown = (e) => {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setSelectedIndex(i => Math.min(i + 1, filteredCommands.length - 1));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      setSelectedIndex(i => Math.max(i - 1, 0));
    } else if (e.key === 'Enter' && filteredCommands[selectedIndex]) {
      e.preventDefault();
      filteredCommands[selectedIndex].action();
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[60] flex items-start justify-center pt-[20vh]">
      <div className="fixed inset-0 bg-black/80" onClick={onClose}></div>
      <div className="relative w-full max-w-xl bg-[#18181b] border border-[#27272a] overflow-hidden animate-scale-in">
        {/* Accent line at top */}
        <div className="h-1 bg-gradient-to-r from-[#2970FF] to-[#84ADFF]"></div>
        {/* Search Input */}
        <div className="flex items-center gap-3 px-4 py-4 border-b border-[#27272a] bg-[#0c0c0e]">
          <svg className="w-5 h-5 text-[#71717a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="square" strokeLinejoin="miter" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            ref={inputRef}
            type="text"
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="SEARCH COMMANDS, CLIENTS..."
            className="flex-1 text-sm bg-transparent outline-none text-white placeholder-[#52525b] uppercase tracking-wider"
          />
          <kbd className="px-2 py-1 text-[10px] font-mono bg-[#27272a] text-[#71717a] font-bold">ESC</kbd>
        </div>

        {/* Results */}
        <div className="max-h-80 overflow-y-auto py-2">
          {filteredCommands.length === 0 ? (
            <div className="px-4 py-8 text-center text-[#71717a]">
              No results found for "{query}"
            </div>
          ) : (
            filteredCommands.map((cmd, index) => (
              <button
                key={index}
                onClick={cmd.action}
                className={`w-full px-4 py-3 flex items-center gap-3 text-left transition-colors ${
                  index === selectedIndex ? 'bg-[#2970FF]/10 text-white' : 'hover:bg-[#27272a]'
                }`}
              >
                <span className="text-xl">{cmd.icon}</span>
                <div className="flex-1 min-w-0">
                  <div className={`font-medium truncate ${index === selectedIndex ? 'text-[#2970FF]' : 'text-white'}`}>
                    {cmd.label}
                  </div>
                  {cmd.subtitle && (
                    <div className="text-sm text-[#71717a] truncate">{cmd.subtitle}</div>
                  )}
                </div>
                {cmd.type === 'action' && (
                  <span className="text-xs text-[#52525b] uppercase font-medium">Action</span>
                )}
              </button>
            ))
          )}
        </div>

        {/* Footer */}
        <div className="border-t border-[#27272a] px-4 py-2 flex items-center gap-4 text-xs text-[#71717a] bg-[#0c0c0e]">
          <span className="flex items-center gap-1">
            <kbd className="px-1.5 py-0.5 bg-[#27272a] rounded font-mono text-[#a1a1aa]">‚Üë‚Üì</kbd> Navigate
          </span>
          <span className="flex items-center gap-1">
            <kbd className="px-1.5 py-0.5 bg-[#27272a] rounded font-mono text-[#a1a1aa]">‚Üµ</kbd> Select
          </span>
          <span className="flex items-center gap-1">
            <kbd className="px-1.5 py-0.5 bg-[#27272a] rounded font-mono text-[#a1a1aa]">ESC</kbd> Close
          </span>
        </div>
      </div>
    </div>
  );
}

// Kanban Board Component
function KanbanBoard({ clients, onUpdateStatus, onSelectClient, formatVolume }) {
  const KYB_STATUSES = ['Pending', 'In Review', 'Approved', 'Rejected'];
  const COLUMN_COLORS = {
    'Pending': { bg: 'bg-gray-50 dark:bg-zinc-900', border: 'border-amber-200 dark:border-amber-900', header: 'bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-400', dot: 'bg-amber-400' },
    'In Review': { bg: 'bg-gray-50 dark:bg-zinc-900', border: 'border-blue-200 dark:border-blue-900', header: 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400', dot: 'bg-blue-400' },
    'Approved': { bg: 'bg-emerald-50 dark:bg-zinc-900', border: 'border-emerald-200 dark:border-emerald-900', header: 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-400', dot: 'bg-emerald-400' },
    'Rejected': { bg: 'bg-red-50 dark:bg-zinc-900', border: 'border-red-200 dark:border-red-900', header: 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-400', dot: 'bg-red-400' }
  };

  const clientsByStatus = useMemo(() => {
    const grouped = {};
    KYB_STATUSES.forEach(status => { grouped[status] = []; });
    clients.forEach(client => {
      if (grouped[client.kybStatus]) grouped[client.kybStatus].push(client);
    });
    return grouped;
  }, [clients]);

  const handleDragStart = (e, client) => {
    e.dataTransfer.setData('clientId', client.id);
    e.dataTransfer.setData('currentStatus', client.kybStatus);
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.currentTarget.classList.add('ring-2', 'ring-slate-400', 'ring-opacity-50');
  };

  const handleDragLeave = (e) => {
    e.currentTarget.classList.remove('ring-2', 'ring-slate-400', 'ring-opacity-50');
  };

  const handleDrop = (e, newStatus) => {
    e.preventDefault();
    e.currentTarget.classList.remove('ring-2', 'ring-slate-400', 'ring-opacity-50');
    const clientId = e.dataTransfer.getData('clientId');
    const currentStatus = e.dataTransfer.getData('currentStatus');
    if (currentStatus !== newStatus) {
      onUpdateStatus(clientId, newStatus);
    }
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      {KYB_STATUSES.map(status => (
        <div
          key={status}
          className={`rounded-xl ${COLUMN_COLORS[status].bg} ${COLUMN_COLORS[status].border} border-2 kanban-column transition-all`}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={(e) => handleDrop(e, status)}
        >
          {/* Column Header */}
          <div className={`px-4 py-3 rounded-t-lg ${COLUMN_COLORS[status].header} flex items-center justify-between`}>
            <div className="flex items-center gap-2">
              <span className={`w-2 h-2 rounded-full ${COLUMN_COLORS[status].dot}`}></span>
              <span className="font-semibold">{status}</span>
            </div>
            <span className="text-sm font-bold bg-white/50 px-2 py-0.5 rounded-full">
              {clientsByStatus[status].length}
            </span>
          </div>

          {/* Cards Container */}
          <div className="p-3 space-y-3 min-h-[300px]">
            {clientsByStatus[status].map(client => {
              const totalVolume = client.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0);
              return (
                <div
                  key={client.id}
                  draggable
                  onDragStart={(e) => handleDragStart(e, client)}
                  onClick={() => onSelectClient(client)}
                  className="bg-white dark:bg-zinc-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-zinc-700 cursor-pointer hover:shadow-md hover:border-[#2970FF] transition-all kanban-card group"
                >
                  <div className="flex items-start justify-between mb-2">
                    <div className="font-semibold text-gray-800 dark:text-white group-hover:text-[#2970FF] transition-colors truncate flex-1">
                      {client.name}
                    </div>
                    <span className={`text-xs px-2 py-0.5 rounded-full ${client.type === 'Aggregator' ? 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400' : 'bg-gray-100 dark:bg-zinc-700 text-gray-600 dark:text-zinc-400'}`}>
                      {client.type === 'Aggregator' ? 'üè¢' : 'üè™'}
                    </span>
                  </div>
                  <div className="text-sm text-gray-500 dark:text-zinc-400 mb-2">
                    {client.corridors.length} corridor{client.corridors.length !== 1 ? 's' : ''}
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="flex flex-wrap gap-1">
                      {client.corridors.slice(0, 3).map((cor, i) => (
                        <span key={i} className="text-xs px-1.5 py-0.5 bg-gray-100 dark:bg-zinc-700 rounded text-gray-600 dark:text-zinc-300">
                          {cor.currency}
                        </span>
                      ))}
                      {client.corridors.length > 3 && (
                        <span className="text-xs px-1.5 py-0.5 bg-gray-100 dark:bg-zinc-700 rounded text-gray-500 dark:text-zinc-400">
                          +{client.corridors.length - 3}
                        </span>
                      )}
                    </div>
                    <span className="text-sm font-mono font-semibold text-gray-700 dark:text-zinc-300">
                      {formatVolume(totalVolume)}
                    </span>
                  </div>
                  {client.tags && client.tags.length > 0 && (
                    <div className="flex flex-wrap gap-1 mt-2 pt-2 border-t dark:border-zinc-700">
                      {client.tags.slice(0, 2).map((tag, i) => (
                        <span key={i} className="text-xs px-2 py-0.5 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-full">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
            {clientsByStatus[status].length === 0 && (
              <div className="text-center py-8 text-gray-400 dark:text-zinc-500">
                <div className="text-3xl mb-2">üì≠</div>
                <div className="text-sm">No clients</div>
              </div>
            )}
          </div>
        </div>
      ))}
    </div>
  );
}

// Bulk Confirm Modal
function BulkConfirmModal({ isOpen, onClose, onConfirm, action, count }) {
  if (!isOpen) return null;

  const actionConfig = {
    delete: { title: 'Delete Items', message: `Are you sure you want to delete ${count} item${count !== 1 ? 's' : ''}? This action cannot be undone.`, confirmText: 'Delete All', confirmClass: 'bg-red-600 hover:bg-red-700' },
    status: { title: 'Change Status', message: `Update status for ${count} item${count !== 1 ? 's' : ''}?`, confirmText: 'Update All', confirmClass: 'bg-blue-600 hover:bg-blue-700' }
  };

  const config = actionConfig[action] || actionConfig.delete;

  return (
    <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
      <div className="fixed inset-0 bg-black/80" onClick={onClose}></div>
      <div className="relative bg-[#18181b] border border-[#27272a] max-w-md w-full p-6 animate-scale-in">
        <div className="h-1 bg-gradient-to-r from-[#2970FF] to-[#84ADFF] w-12 mb-4"></div>
        <h3 className="text-lg font-black text-white uppercase tracking-wider mb-2">{config.title}</h3>
        <p className="text-[#a1a1aa] mb-6">{config.message}</p>
        <div className="flex justify-end gap-3">
          <button onClick={onClose} className="px-4 py-2.5 bg-[#27272a] border border-[#3f3f46] text-[#a1a1aa] text-xs font-bold uppercase tracking-wider hover:border-white hover:text-white transition-colors">
            Cancel
          </button>
          <button onClick={onConfirm} className={`px-4 py-2.5 text-xs font-bold uppercase tracking-wider transition-colors ${action === 'delete' ? 'bg-red-500 text-white hover:bg-red-600' : 'btn-primary'}`}>
            {config.confirmText}
          </button>
        </div>
      </div>
    </div>
  );
}

// Column Settings Dropdown
function ColumnSettings({ columns, visibleColumns, onToggle, onClose }) {
  const menuRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (menuRef.current && !menuRef.current.contains(e.target)) onClose();
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [onClose]);

  return (
    <div ref={menuRef} className="absolute right-0 top-full mt-2 bg-white rounded-xl shadow-lg border border-gray-200 py-2 min-w-[200px] z-50 animate-scale-in">
      <p className="px-4 py-2 text-xs font-semibold text-slate-300 uppercase border-b">Show Columns</p>
      {columns.map(col => (
        <label key={col.key} className="flex items-center gap-3 px-4 py-2 hover:bg-gray-50 cursor-pointer">
          <input
            type="checkbox"
            checked={visibleColumns.includes(col.key)}
            onChange={() => onToggle(col.key)}
            disabled={col.key === 'name' || col.key === 'actions'}
            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-cyan-500"
          />
          <span className={`text-sm ${visibleColumns.includes(col.key) ? 'text-gray-700' : 'text-slate-300'}`}>{col.label}</span>
        </label>
      ))}
    </div>
  );
}

// Context Menu Component (Right-click menu)
function ContextMenu({ x, y, client, onClose, onChangeStatus, onEdit, onDelete, onPin, isPinned }) {
  const menuRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (menuRef.current && !menuRef.current.contains(e.target)) onClose();
    };
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    document.addEventListener('mousedown', handleClickOutside);
    document.addEventListener('keydown', handleEsc);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
      document.removeEventListener('keydown', handleEsc);
    };
  }, [onClose]);

  const KYB_STATUSES = ['Pending', 'In Review', 'Approved', 'Rejected'];

  return (
    <div
      ref={menuRef}
      className="fixed z-[70] bg-white rounded-xl shadow-lg border border-gray-200 py-2 min-w-[200px] animate-scale-in"
      style={{ left: Math.min(x, window.innerWidth - 220), top: Math.min(y, window.innerHeight - 300) }}
    >
      <div className="px-3 py-2 border-b mb-1">
        <p className="text-sm font-semibold text-gray-800 truncate">{client.name}</p>
        <p className="text-xs text-slate-400">{client.type}</p>
      </div>

      {/* Status Change Submenu */}
      <div className="px-1">
        <p className="px-3 py-1 text-xs font-semibold text-slate-300 uppercase">Change Status</p>
        {KYB_STATUSES.map(status => (
          <button
            key={status}
            onClick={() => { onChangeStatus(client.id, status); onClose(); }}
            disabled={client.kybStatus === status}
            className={`w-full px-3 py-2 text-left text-sm flex items-center gap-2 rounded-lg transition-colors ${
              client.kybStatus === status ? 'bg-gray-100 text-slate-300' : 'hover:bg-gray-50 text-gray-700'
            }`}
          >
            <span className={`w-2 h-2 rounded-full ${
              status === 'Pending' ? 'bg-amber-400' :
              status === 'In Review' ? 'bg-blue-400' :
              status === 'Approved' ? 'bg-emerald-400' : 'bg-red-400'
            }`}></span>
            {status}
            {client.kybStatus === status && <span className="ml-auto text-xs">‚úì</span>}
          </button>
        ))}
      </div>

      <div className="border-t mt-1 pt-1 px-1">
        <button
          onClick={() => { onPin(client.id); onClose(); }}
          className="w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
        >
          {isPinned ? (
            <>
              <svg className="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              Unpin
            </>
          ) : (
            <>
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
              </svg>
              Pin to Top
            </>
          )}
        </button>
        <button
          onClick={() => { onEdit(client); onClose(); }}
          className="w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          Edit Client
        </button>
        <button
          onClick={() => { onDelete(client); onClose(); }}
          className="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Delete
        </button>
      </div>
    </div>
  );
}

// Referral Context Menu Component
function ReferralContextMenu({ x, y, referral, onClose, onChangeStatus, onEdit, onDelete }) {
  const menuRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (menuRef.current && !menuRef.current.contains(e.target)) onClose();
    };
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    document.addEventListener('mousedown', handleClickOutside);
    document.addEventListener('keydown', handleEsc);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
      document.removeEventListener('keydown', handleEsc);
    };
  }, [onClose]);

  const STATUSES = ['Lead', 'In Discussion', 'Negotiating', 'Closed Won', 'Closed Lost'];
  const STATUS_COLORS = {
    'Lead': 'bg-gray-400',
    'In Discussion': 'bg-blue-400',
    'Negotiating': 'bg-amber-400',
    'Closed Won': 'bg-emerald-400',
    'Closed Lost': 'bg-red-400'
  };

  return (
    <div
      ref={menuRef}
      className="fixed z-[70] bg-white rounded-xl shadow-lg border border-gray-200 py-2 min-w-[200px] animate-scale-in"
      style={{ left: Math.min(x, window.innerWidth - 220), top: Math.min(y, window.innerHeight - 350) }}
    >
      <div className="px-3 py-2 border-b mb-1">
        <p className="text-sm font-semibold text-gray-800 truncate">{referral.referredCompany}</p>
        <p className="text-xs text-slate-400">Referral</p>
      </div>

      <div className="px-1">
        <p className="px-3 py-1 text-xs font-semibold text-slate-300 uppercase">Change Status</p>
        {STATUSES.map(status => (
          <button
            key={status}
            onClick={() => { onChangeStatus(referral.id, status); onClose(); }}
            disabled={referral.status === status}
            className={`w-full px-3 py-2 text-left text-sm flex items-center gap-2 rounded-lg transition-colors ${
              referral.status === status ? 'bg-gray-100 text-slate-300' : 'hover:bg-gray-50 text-gray-700'
            }`}
          >
            <span className={`w-2 h-2 rounded-full ${STATUS_COLORS[status]}`}></span>
            {status}
            {referral.status === status && <span className="ml-auto text-xs">‚úì</span>}
          </button>
        ))}
      </div>

      <div className="border-t mt-1 pt-1 px-1">
        <button
          onClick={() => { onEdit(referral); onClose(); }}
          className="w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          Edit Referral
        </button>
        <button
          onClick={() => { onDelete(referral); onClose(); }}
          className="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Delete
        </button>
      </div>
    </div>
  );
}

// Inline Edit Component
function InlineEdit({ value, onSave, className }) {
  const [isEditing, setIsEditing] = useState(false);
  const [editValue, setEditValue] = useState(value);
  const inputRef = useRef(null);

  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus();
      inputRef.current.select();
    }
  }, [isEditing]);

  const handleSave = () => {
    if (editValue.trim() && editValue !== value) {
      onSave(editValue.trim());
    }
    setIsEditing(false);
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') handleSave();
    if (e.key === 'Escape') { setEditValue(value); setIsEditing(false); }
  };

  if (isEditing) {
    return (
      <input
        ref={inputRef}
        type="text"
        value={editValue}
        onChange={(e) => setEditValue(e.target.value)}
        onBlur={handleSave}
        onKeyDown={handleKeyDown}
        className={`px-2 py-1 border border-blue-400 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none ${className}`}
      />
    );
  }

  return (
    <span
      onDoubleClick={(e) => { e.stopPropagation(); setIsEditing(true); }}
      className={`cursor-text hover:bg-blue-50 px-1 -mx-1 rounded transition-colors ${className}`}
      title="Double-click to edit"
    >
      {value}
    </span>
  );
}

// Modal Component
function Modal({ isOpen, onClose, title, children }) {
  useEffect(() => {
    const handleEscape = (e) => { if (e.key === 'Escape' && isOpen) onClose(); };
    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="fixed inset-0 bg-black/80 animate-fade-in" onClick={onClose}></div>
      <div className="relative bg-[#18181b] border border-[#27272a] max-w-2xl w-full max-h-[90vh] overflow-hidden animate-scale-in">
        {/* Accent line at top */}
        <div className="h-1 bg-gradient-to-r from-[#2970FF] to-[#84ADFF]"></div>
        <div className="sticky top-0 bg-[#18181b] border-b border-[#27272a] px-6 py-4 flex items-center justify-between z-10">
          <h2 className="text-lg font-black text-white uppercase tracking-wider">{title}</h2>
          <button onClick={onClose} className="p-2 hover:bg-[#27272a] transition-all" title="Close (Esc)">
            <svg className="w-5 h-5 text-[#71717a] hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="square" strokeLinejoin="miter" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div className="p-6 overflow-y-auto max-h-[calc(90vh-70px)]">{children}</div>
      </div>
    </div>
  );
}

// Delete Confirmation Modal
function DeleteModal({ isOpen, onClose, onConfirm, clientName }) {
  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Confirm Delete">
      <p className="text-[#a1a1aa] mb-6">
        Are you sure you want to delete <span className="font-bold text-white">{clientName}</span>? This action cannot be undone.
      </p>
      <div className="flex justify-end gap-3">
        <button onClick={onClose} className="px-4 py-2.5 bg-[#27272a] border border-[#3f3f46] text-[#a1a1aa] text-xs font-bold uppercase tracking-wider hover:border-white hover:text-white transition-colors">
          Cancel
        </button>
        <button onClick={onConfirm} className="px-4 py-2.5 bg-red-500 text-white text-xs font-bold uppercase tracking-wider hover:bg-red-600 transition-colors">
          Delete
        </button>
      </div>
    </Modal>
  );
}

// Network Visualization Modal - Hub and Spoke diagram
function NetworkModal({ isOpen, onClose, aggregator, subMerchants }) {
  if (!isOpen || !aggregator) return null;

  const formatVolume = (v) => {
    if (v >= 1000000) return `$${(v / 1000000).toFixed(1)}M`;
    if (v >= 1000) return `$${(v / 1000).toFixed(0)}K`;
    return `$${v}`;
  };

  const getKybColor = (status) => {
    const colors = {
      'Pending': '#facc15',
      'In Review': '#3b82f6',
      'Approved': '#22c55e',
      'Rejected': '#ef4444'
    };
    return colors[status] || '#9ca3af';
  };

  const centerX = 250;
  const centerY = 200;
  const radius = 140;

  // Calculate positions for sub-merchants in a circle around the center
  const getNodePositions = () => {
    if (subMerchants.length === 0) return [];

    const angleStep = (2 * Math.PI) / Math.max(subMerchants.length, 1);
    const startAngle = -Math.PI / 2; // Start from top

    return subMerchants.map((sm, index) => {
      const angle = startAngle + (index * angleStep);
      return {
        ...sm,
        x: centerX + radius * Math.cos(angle),
        y: centerY + radius * Math.sin(angle)
      };
    });
  };

  const nodes = getNodePositions();
  const totalSubVolume = subMerchants.reduce((sum, sm) =>
    sum + sm.corridors.reduce((s, c) => s + (c.expectedVolume || 0), 0), 0);
      const aggVolume = totalSubVolume;

  return (
    <div className="fixed inset-0 z-40 flex items-center justify-center">
      <div className="fixed inset-0 bg-black/50 animate-fade-in" onClick={onClose}></div>
      <div className="relative bg-white rounded-xl shadow-lg max-w-3xl w-full mx-4 animate-scale-in">
        <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between rounded-t-xl">
          <div>
            <h2 className="text-xl font-semibold text-gray-800">{aggregator.name}</h2>
            <p className="text-sm text-slate-400">Network Visualization ‚Ä¢ {subMerchants.length} sub-merchant{subMerchants.length !== 1 ? 's' : ''}</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div className="p-6">
          {subMerchants.length === 0 ? (
            <div className="text-center py-12 text-slate-300">
              <svg className="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <p className="text-lg font-medium">No sub-merchants yet</p>
              <p className="text-sm">Add sub-merchants and link them to this aggregator</p>
            </div>
          ) : (
            <svg viewBox="0 0 500 400" className="w-full h-auto">
              {/* Connection lines */}
              {nodes.map((node, index) => (
                <line
                  key={`line-${index}`}
                  x1={centerX}
                  y1={centerY}
                  x2={node.x}
                  y2={node.y}
                  stroke="#e5e7eb"
                  strokeWidth="2"
                  className="animate-draw-line"
                  style={{ animationDelay: `${index * 0.1}s` }}
                />
              ))}

              {/* Sub-merchant nodes */}
              {nodes.map((node, index) => {
                const volume = node.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0);
                return (
                  <g key={node.id} className="animate-pop-in cursor-pointer hover:opacity-80" onClick={() => alert(`Company: ${node.name}
KYB Status: ${node.kybStatus}
Volume: $${volume.toLocaleString()}`)} style={{ animationDelay: `${0.2 + index * 0.1}s` }}>
                    {/* Node circle */}
                    <ellipse
                      cx={node.x}
                      cy={node.y}
                      rx="55"
                      ry="35"
                      fill="white"
                      stroke={getKybColor(node.kybStatus)}
                      strokeWidth="3"
                      className="drop-shadow-md"
                    />
                    {/* Node text */}
                    <text
                      x={node.x}
                      y={node.y - 6}
                      textAnchor="middle"
                      className="text-xs font-medium fill-gray-700"
                      style={{ fontSize: '10px' }}
                    >
                      {node.name.length > 12 ? node.name.substring(0, 12) + '...' : node.name}
                    </text>
                    <text
                      x={node.x}
                      y={node.y + 8}
                      textAnchor="middle"
                      className="font-mono fill-gray-500"
                      style={{ fontSize: '9px' }}
                    >
                      {formatVolume(volume)}
                    </text>
                    {/* KYB status indicator */}
                    <circle
                      cx={node.x + 45}
                      cy={node.y - 25}
                      r="6"
                      fill={getKybColor(node.kybStatus)}
                    />
                  </g>
                );
              })}

              {/* Center aggregator node */}
              <g className="animate-pop-in">
                <ellipse
                  cx={centerX}
                  cy={centerY}
                  rx="70"
                  ry="45"
                  fill="#3b82f6"
                  stroke="#2563eb"
                  strokeWidth="4"
                  className="drop-shadow-lg"
                />
                <text
                  x={centerX}
                  y={centerY - 8}
                  textAnchor="middle"
                  className="text-sm font-semibold fill-white"
                  style={{ fontSize: '12px' }}
                >
                  {aggregator.name.length > 14 ? aggregator.name.substring(0, 14) + '...' : aggregator.name}
                </text>
                <text
                  x={centerX}
                  y={centerY + 10}
                  textAnchor="middle"
                  className="font-mono fill-teal-100"
                  style={{ fontSize: '11px' }}
                >
                  {formatVolume(aggVolume)}
                </text>
              </g>
            </svg>
          )}

          {/* Summary stats */}
          <div className="mt-4 pt-4 border-t grid grid-cols-3 gap-4 text-center">
            <div className="p-3 bg-gray-50 rounded-lg">
              <p className="text-xs text-blue-600 uppercase tracking-wide">Aggregator Volume</p>
              <p className="text-lg font-semibold font-mono text-blue-700">{formatVolume(aggVolume)}</p>
            </div>
            <div className="p-3 bg-gray-50 rounded-lg">
              <p className="text-xs text-blue-600 uppercase tracking-wide">Sub-merchant Volume</p>
              <p className="text-lg font-semibold font-mono text-blue-700">{formatVolume(totalSubVolume)}</p>
            </div>
            <div className="p-3 bg-gray-50 rounded-lg">
              <p className="text-xs text-gray-600 uppercase tracking-wide">Total Network</p>
              <p className="text-lg font-semibold font-mono text-gray-700">{formatVolume(totalSubVolume)}</p>
            </div>
          </div>

          {/* Legend */}
          {subMerchants.length > 0 && (
            <div className="mt-4 flex flex-wrap justify-center gap-4 text-xs text-slate-400">
              <div className="flex items-center gap-1">
                <span className="w-3 h-3 rounded-full bg-yellow-400"></span> Pending
              </div>
              <div className="flex items-center gap-1">
                <span className="w-3 h-3 rounded-full bg-gray-500"></span> In Review
              </div>
              <div className="flex items-center gap-1">
                <span className="w-3 h-3 rounded-full bg-slate-80bg-emerald-600bg-gray-500bg-gray-50text-slate-4000"></span> Approved
              </div>
              <div className="flex items-center gap-1">
                <span className="w-3 h-3 rounded-full bg-red-500"></span> Rejected
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// Referral Network Modal - Hub and Spoke diagram for referrers
function ReferralNetworkModal({ isOpen, onClose, referrer, referrals }) {
  if (!isOpen || !referrer) return null;

  const getStatusColor = (status) => {
    const colors = {
      'Active': '#22c55e',
      'Pending': '#facc15',
      'Inactive': '#9ca3af'
    };
    return colors[status] || '#9ca3af';
  };

  const centerX = 250;
  const centerY = 200;
  const radius = 140;

  const getNodePositions = () => {
    if (referrals.length === 0) return [];
    const angleStep = (2 * Math.PI) / Math.max(referrals.length, 1);
    const startAngle = -Math.PI / 2;
    return referrals.map((ref, index) => {
      const angle = startAngle + (index * angleStep);
      return { ...ref, x: centerX + radius * Math.cos(angle), y: centerY + radius * Math.sin(angle) };
    });
  };

  const nodes = getNodePositions();
  const totalReferrals = referrals.length;
  const activeReferrals = referrals.filter(r => r.status === 'Active').length;

  return (
    <div className="fixed inset-0 z-40 flex items-center justify-center">
      <div className="fixed inset-0 bg-black/50 animate-fade-in" onClick={onClose}></div>
      <div className="relative bg-white rounded-xl shadow-lg max-w-3xl w-full mx-4 animate-scale-in">
        <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between rounded-t-xl">
          <div>
            <h2 className="text-xl font-semibold text-gray-800">{referrer.name}</h2>
            <p className="text-sm text-slate-400">Referral Network ‚Ä¢ {totalReferrals} referral{totalReferrals !== 1 ? 's' : ''}</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div className="p-6">
          {referrals.length === 0 ? (
            <div className="text-center py-12 text-slate-300">
              <svg className="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <p className="text-lg font-medium">No referrals yet</p>
              <p className="text-sm">Add New Clients linked to this referring client</p>
            </div>
          ) : (
            <svg viewBox="0 0 500 400" className="w-full h-auto">
              {nodes.map((node, index) => (
                <line key={`line-${index}`} x1={centerX} y1={centerY} x2={node.x} y2={node.y}
                  stroke="#e5e7eb" strokeWidth="2" className="animate-draw-line"
                  style={{ animationDelay: `${index * 0.1}s` }} />
              ))}
              {nodes.map((node, index) => (
                <g key={node.id} className="animate-pop-in cursor-pointer hover:opacity-80" onClick={() => alert(`Company: ${node.name}
KYB Status: ${node.kybStatus}
Volume: $${volume.toLocaleString()}`)} style={{ animationDelay: `${0.2 + index * 0.1}s` }}>
                  <ellipse cx={node.x} cy={node.y} rx="55" ry="35" fill="white"
                    stroke={getStatusColor(node.status)} strokeWidth="3" className="drop-shadow-md" />
                  <text x={node.x} y={node.y - 6} textAnchor="middle" className="text-xs font-medium fill-gray-700" style={{ fontSize: '10px' }}>
                    {node.referredCompany.length > 12 ? node.referredCompany.substring(0, 12) + '...' : node.referredCompany}
                  </text>
                  <text x={node.x} y={node.y + 8} textAnchor="middle" className="font-mono fill-gray-500" style={{ fontSize: '9px' }}>
                    {node.currencies.length} currencies
                  </text>
                  <circle cx={node.x + 45} cy={node.y - 25} r="6" fill={getStatusColor(node.status)} />
                </g>
              ))}
              <g className="animate-pop-in">
                <ellipse cx={centerX} cy={centerY} rx="70" ry="45" fill="#3b82f6" stroke="#2563eb" strokeWidth="4" className="drop-shadow-lg" />
                <text x={centerX} y={centerY - 8} textAnchor="middle" className="text-sm font-semibold fill-white" style={{ fontSize: '12px' }}>
                  {referrer.name.length > 14 ? referrer.name.substring(0, 14) + '...' : referrer.name}
                </text>
                <text x={centerX} y={centerY + 10} textAnchor="middle" className="font-mono fill-purple-200" style={{ fontSize: '11px' }}>
                  {referrer.type}
                </text>
              </g>
            </svg>
          )}

          <div className="mt-4 pt-4 border-t grid grid-cols-3 gap-4 text-center">
            <div className="p-3 bg-gray-50 rounded-lg">
              <p className="text-xs text-blue-600 uppercase tracking-wide">Total Referrals</p>
              <p className="text-lg font-semibold font-mono text-blue-700">{totalReferrals}</p>
            </div>
            <div className="p-3 bg-green-50 rounded-lg">
              <p className="text-xs text-green-600 uppercase tracking-wide">Active</p>
              <p className="text-lg font-semibold font-mono text-green-700">{activeReferrals}</p>
            </div>
            <div className="p-3 bg-gray-50 rounded-lg">
              <p className="text-xs text-gray-600 uppercase tracking-wide">Conversion Rate</p>
              <p className="text-lg font-semibold font-mono text-gray-700">{totalReferrals > 0 ? Math.round((activeReferrals / totalReferrals) * 100) : 0}%</p>
            </div>
          </div>

          {referrals.length > 0 && (
            <div className="mt-4 flex flex-wrap justify-center gap-4 text-xs text-slate-400">
              <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-slate-80bg-emerald-600bg-gray-500bg-gray-50text-slate-4000"></span> Active</div>
              <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-yellow-400"></span> Pending</div>
              <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-gray-400"></span> Inactive</div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// Referrer Form Component
function ReferrerForm({ referrer, onSave, onClose }) {
  const [formData, setFormData] = useState(referrer || {
    name: '',
    type: 'Partner',
    contactEmail: '',
    feeSplitPercentage: '',
    notes: ''
  });
  const [errors, setErrors] = useState({});

  const validate = () => {
    const newErrors = {};
    if (!formData.name.trim()) newErrors.name = 'Name is required';
    if (formData.contactEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.contactEmail)) {
      newErrors.contactEmail = 'Please enter a valid email';
    }
    if (formData.feeSplitPercentage && (isNaN(formData.feeSplitPercentage) || Number(formData.feeSplitPercentage) < 0 || Number(formData.feeSplitPercentage) > 100)) {
      newErrors.feeSplitPercentage = 'Fee split must be between 0 and 100%';
    }
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validate()) {
      onSave({ ...formData, id: formData.id || generateId(), feeSplitPercentage: formData.feeSplitPercentage ? Number(formData.feeSplitPercentage) : 0 });
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-5">
      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Referrer Name (Who brings new clients?) Name *</label>
        <input type="text" value={formData.name}
          onChange={(e) => setFormData({ ...formData, name: e.target.value })}
          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all ${errors.name ? 'border-red-500' : 'border-gray-300'}`}
          placeholder="Enter name" />
        {errors.name && <p className="text-red-500 text-sm mt-1">{errors.name}</p>}
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Type</label>
          <select value={formData.type} onChange={(e) => setFormData({ ...formData, type: e.target.value })}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            {REFERRER_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Contact Email</label>
          <input type="email" value={formData.contactEmail}
            onChange={(e) => setFormData({ ...formData, contactEmail: e.target.value })}
            className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none ${errors.contactEmail ? 'border-red-500' : 'border-gray-300'}`}
            placeholder="email@example.com" />
          {errors.contactEmail && <p className="text-red-500 text-sm mt-1">{errors.contactEmail}</p>}
        </div>
      </div>

      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Fee Split Percentage</label>
        <p className="text-xs text-slate-400 mb-2">The percentage of revenue to share with this referrer</p>
        <div className="relative w-48">
          <input type="number" step="0.01" min="0" max="100" value={formData.feeSplitPercentage}
            onChange={(e) => setFormData({ ...formData, feeSplitPercentage: e.target.value })}
            className={`w-full px-4 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-mono ${errors.feeSplitPercentage ? 'border-red-500' : 'border-gray-300'}`}
            placeholder="0.00" />
          <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300">%</span>
        </div>
        {errors.feeSplitPercentage && <p className="text-red-500 text-sm mt-1">{errors.feeSplitPercentage}</p>}
      </div>

      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Notes</label>
        <textarea value={formData.notes} onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
          rows={3} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
          placeholder="Optional notes..." />
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t border-[#27272a]">
        <button type="button" onClick={onClose} className="px-4 py-2.5 bg-[#27272a] border border-[#3f3f46] text-[#a1a1aa] text-xs font-bold uppercase tracking-wider hover:border-white hover:text-white transition-colors">Cancel</button>
        <button type="submit" className="btn-primary px-5 py-2.5">
          {referrer ? 'Update Partner' : 'Add Partner'}
        </button>
      </div>
    </form>
  );
}

// Referral Form Component (for adding referred companies with cost per transaction)
function ReferralForm({ referral, onSave, onClose, allReferrers }) {
  const [formData, setFormData] = useState(referral || {
    referrerId: '',
    referredCompany: '',
    status: 'Pending',
    currencies: [{ id: generateId(), currency: 'USD', costPercentage: '' }],
    notes: ''
  });
  const [errors, setErrors] = useState({});

  const validate = () => {
    const newErrors = {};
    if (!formData.referrerId) newErrors.referrerId = 'Please select a referring client';
    if (!formData.referredCompany.trim()) newErrors.referredCompany = 'Referred company name is required';
    formData.currencies.forEach((c, i) => {
      if (c.costPercentage && (isNaN(c.costPercentage) || Number(c.costPercentage) < 0 || Number(c.costPercentage) > 100)) {
        newErrors[`currency_${i}`] = 'Cost must be between 0 and 100%';
      }
    });
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validate()) {
      onSave({
        ...formData,
        id: formData.id || generateId(),
        currencies: formData.currencies.map(c => ({ ...c, costPercentage: c.costPercentage ? Number(c.costPercentage) : 0 }))
      });
    }
  };

  const addCurrency = () => {
    setFormData({
      ...formData,
      currencies: [...formData.currencies, { id: generateId(), currency: 'USD', costPercentage: '' }]
    });
  };

  const removeCurrency = (id) => {
    if (formData.currencies.length > 1) {
      setFormData({ ...formData, currencies: formData.currencies.filter(c => c.id !== id) });
    }
  };

  const updateCurrency = (id, field, value) => {
    setFormData({
      ...formData,
      currencies: formData.currencies.map(c => c.id === id ? { ...c, [field]: value } : c)
    });
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-5">
      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Who is bringing this client? (Referrer) *</label>
        <select value={formData.referrerId} onChange={(e) => setFormData({ ...formData, referrerId: e.target.value })}
          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none ${errors.referrerId ? 'border-red-500' : 'border-gray-300'}`}>
          <option value="">Select a referrer...</option>
          {allReferrers.map(r => <option key={r.id} value={r.id}>{r.name} ({r.type})</option>)}
        </select>
        {errors.referrerId && <p className="text-red-500 text-sm mt-1">{errors.referrerId}</p>}
      </div>

      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">New Client Name (Who is being referred?) *</label>
        <input type="text" value={formData.referredCompany}
          onChange={(e) => setFormData({ ...formData, referredCompany: e.target.value })}
          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none ${errors.referredCompany ? 'border-red-500' : 'border-gray-300'}`}
          placeholder="Company name" />
        {errors.referredCompany && <p className="text-red-500 text-sm mt-1">{errors.referredCompany}</p>}
      </div>

      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Status</label>
        <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
          {REFERRAL_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
        </select>
      </div>

      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium text-gray-700">Cost per Transaction by Currency</label>
          <button type="button" onClick={addCurrency} className="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
            Add Currency
          </button>
        </div>
        <div className="space-y-3">
          {formData.currencies.map((curr, index) => (
            <div key={curr.id} className="flex gap-2 items-start p-3 bg-gray-50 rounded-lg">
              <div className="flex-1">
                <select value={curr.currency} onChange={(e) => updateCurrency(curr.id, 'currency', e.target.value)}
                  className="w-full px-3 py-2.5 bg-[#0c0c0e] border border-[#27272a] text-white text-sm focus:border-[#2970FF] focus:ring-0 outline-none transition-colors">
                  {CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              <div className="flex-1">
                <div className="relative">
                  <input type="number" step="0.01" min="0" max="100" value={curr.costPercentage}
                    onChange={(e) => updateCurrency(curr.id, 'costPercentage', e.target.value)}
                    placeholder="Cost %"
                    className="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" />
                  <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 text-sm">%</span>
                </div>
              </div>
              <button type="button" onClick={() => removeCurrency(curr.id)} disabled={formData.currencies.length === 1}
                className="p-2 text-slate-300 hover:text-red-500 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          ))}
        </div>
        {Object.keys(errors).filter(k => k.startsWith('currency_')).map(k => (
          <p key={k} className="text-red-500 text-sm mt-1">{errors[k]}</p>
        ))}
      </div>

      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Notes</label>
        <textarea value={formData.notes} onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
          rows={3} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
          placeholder="Optional notes..." />
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t border-[#27272a]">
        <button type="button" onClick={onClose} className="px-4 py-2.5 bg-[#27272a] border border-[#3f3f46] text-[#a1a1aa] text-xs font-bold uppercase tracking-wider hover:border-white hover:text-white transition-colors">Cancel</button>
        <button type="submit" className="btn-primary px-5 py-2.5">
          {referral ? 'Update Client' : 'Add New Client'}
        </button>
      </div>
    </form>
  );
}

// Referral Stats Bar Component
function ReferralStatsBar({ referrers, referrals }) {
  const stats = useMemo(() => {
    const statusCounts = REFERRAL_STATUSES.reduce((acc, s) => ({ ...acc, [s]: 0 }), {});
    let avgCostPercent = 0;
    let costCount = 0;

    referrals.forEach(r => {
      statusCounts[r.status]++;
      r.currencies.forEach(c => {
        if (c.costPercentage > 0) {
          avgCostPercent += c.costPercentage;
          costCount++;
        }
      });
    });

    return {
      totalReferrers: referrers.length,
      totalReferrals: referrals.length,
      statusCounts,
      avgCost: costCount > 0 ? (avgCostPercent / costCount).toFixed(2) : 0
    };
  }, [referrers, referrals]);

  return (
    <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6 animate-fade-in">
      {/* Partners */}
      <div className="stat-card p-4 border-[#2970FF] bg-[#2970FF]/5">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-[#2970FF] flex items-center justify-center">
            <svg className="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
              <path strokeLinecap="square" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
            </svg>
          </div>
          <div>
            <p className="text-[10px] text-[#84ADFF] uppercase tracking-[0.15em] font-bold">Partners</p>
            <p className="text-2xl font-black font-mono text-gray-900 dark:text-white">{stats.totalReferrers}</p>
          </div>
        </div>
      </div>

      {/* Referrals */}
      <div className="stat-card p-4">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gray-100 dark:bg-[#27272a] flex items-center justify-center">
            <svg className="w-5 h-5 text-[#84ADFF]" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
              <path strokeLinecap="square" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
          </div>
          <div>
            <p className="text-[10px] text-gray-500 dark:text-[#71717a] uppercase tracking-[0.15em] font-bold">Referrals</p>
            <p className="text-2xl font-black font-mono text-gray-900 dark:text-white">{stats.totalReferrals}</p>
          </div>
        </div>
      </div>

      {/* Active */}
      <div className="stat-card p-4">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gray-100 dark:bg-[#27272a] flex items-center justify-center">
            <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2.5}>
              <path strokeLinecap="square" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div>
            <p className="text-[10px] text-gray-500 dark:text-[#71717a] uppercase tracking-[0.15em] font-bold">Active</p>
            <p className="text-2xl font-black font-mono text-emerald-500">{stats.statusCounts['Active']}</p>
          </div>
        </div>
      </div>

      {/* Pending */}
      <div className="stat-card p-4">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gray-100 dark:bg-[#27272a] flex items-center justify-center">
            <svg className="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
              <path strokeLinecap="square" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <p className="text-[10px] text-gray-500 dark:text-[#71717a] uppercase tracking-[0.15em] font-bold">Pending</p>
            <p className="text-2xl font-black font-mono text-amber-500">{stats.statusCounts['Pending']}</p>
          </div>
        </div>
      </div>

      {/* Inactive */}
      <div className="stat-card p-4">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gray-100 dark:bg-[#27272a] flex items-center justify-center">
            <svg className="w-5 h-5 text-[#71717a]" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
              <path strokeLinecap="square" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
          </div>
          <div>
            <p className="text-[10px] text-gray-500 dark:text-[#71717a] uppercase tracking-[0.15em] font-bold">Inactive</p>
            <p className="text-2xl font-black font-mono text-[#71717a]">{stats.statusCounts['Inactive']}</p>
          </div>
        </div>
      </div>

      {/* Avg Cost */}
      <div className="stat-card p-4">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gray-100 dark:bg-[#27272a] flex items-center justify-center">
            <svg className="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
              <path strokeLinecap="square" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <p className="text-[10px] text-gray-500 dark:text-[#71717a] uppercase tracking-[0.15em] font-bold">Avg Cost</p>
            <p className="text-2xl font-black font-mono text-orange-500">{stats.avgCost}%</p>
          </div>
        </div>
      </div>
    </div>
  );
}

// Client Form Component
function ClientForm({ client, onSave, onClose, allClients }) {
  const [formData, setFormData] = useState(client || {
    name: '',
    type: 'Aggregator',
    inFlowOfFunds: false,
    corridors: [{ id: generateId(), currency: 'USD', expectedVolume: '', priority: 'Med' }],
    sumsubLink: '',
    kybStatus: 'Pending',
    notes: '',
    parentAggregatorId: '',
    tags: []
  });
  const [errors, setErrors] = useState({});
  const [tagInput, setTagInput] = useState('');

  const SUGGESTED_TAGS = ['Priority', 'Enterprise', 'Q1 Launch', 'High Volume', 'New', 'VIP', 'At Risk', 'Upsell'];

  const addTag = (tag) => {
    const trimmedTag = tag.trim();
    if (trimmedTag && !(formData.tags || []).includes(trimmedTag)) {
      setFormData({ ...formData, tags: [...(formData.tags || []), trimmedTag] });
    }
    setTagInput('');
  };

  const removeTag = (tagToRemove) => {
    setFormData({ ...formData, tags: (formData.tags || []).filter(t => t !== tagToRemove) });
  };

  // Get list of aggregators (excluding self if editing)
  const availableAggregators = useMemo(() => {
    return allClients.filter(c => c.type === 'Aggregator' && c.id !== formData.id);
  }, [allClients, formData.id]);

  const validate = () => {
    const newErrors = {};
    if (!formData.name.trim()) newErrors.name = 'Client name is required';
    if (formData.sumsubLink && !/^https?:\/\/.+/.test(formData.sumsubLink)) {
      newErrors.sumsubLink = 'Please enter a valid URL';
    }
    formData.corridors.forEach((c, i) => {
      if (c.expectedVolume && (isNaN(c.expectedVolume) || Number(c.expectedVolume) < 0)) {
        newErrors[`corridor_${i}`] = 'Volume must be a positive number';
      }
    });
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validate()) {
      onSave({
        ...formData,
        id: formData.id || generateId(),
        corridors: formData.corridors.map(c => ({
          ...c,
          expectedVolume: c.expectedVolume ? Number(c.expectedVolume) : 0
        }))
      });
    }
  };

  const addCorridor = () => {
    setFormData({
      ...formData,
      corridors: [...formData.corridors, { id: generateId(), currency: 'USD', expectedVolume: '', priority: 'Med' }]
    });
  };

  const removeCorridor = (id) => {
    if (formData.corridors.length > 1) {
      setFormData({
        ...formData,
        corridors: formData.corridors.filter(c => c.id !== id)
      });
    }
  };

  const updateCorridor = (id, field, value) => {
    setFormData({
      ...formData,
      corridors: formData.corridors.map(c => c.id === id ? { ...c, [field]: value } : c)
    });
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-5">
      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Client Name *</label>
        <input
          type="text"
          value={formData.name}
          onChange={(e) => setFormData({ ...formData, name: e.target.value })}
          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all ${errors.name ? 'border-red-500' : 'border-gray-300'}`}
          placeholder="Enter client name"
        />
        {errors.name && <p className="text-red-500 text-sm mt-1">{errors.name}</p>}
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Type</label>
          <select
            value={formData.type}
            onChange={(e) => setFormData({ ...formData, type: e.target.value, parentAggregatorId: e.target.value === 'Aggregator' ? '' : formData.parentAggregatorId })}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
          >
            {CLIENT_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">KYB Status</label>
          <select
            value={formData.kybStatus}
            onChange={(e) => setFormData({ ...formData, kybStatus: e.target.value })}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
          >
            {KYB_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      </div>

      {formData.type === 'Sub-merchant' && (
        <div>
          <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Parent Aggregator</label>
          <select
            value={formData.parentAggregatorId || ''}
            onChange={(e) => setFormData({ ...formData, parentAggregatorId: e.target.value })}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
          >
            <option value="">No parent (standalone)</option>
            {availableAggregators.map(agg => (
              <option key={agg.id} value={agg.id}>{agg.name}</option>
            ))}
          </select>
          <p className="text-xs text-slate-400 mt-1">Associate this sub-merchant with an aggregator</p>
        </div>
      )}

      <div className="flex items-center gap-3">
        <label className="relative inline-flex items-center cursor-pointer">
          <input
            type="checkbox"
            checked={formData.inFlowOfFunds}
            onChange={(e) => setFormData({ ...formData, inFlowOfFunds: e.target.checked })}
            className="sr-only peer"
          />
          <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
        </label>
        <span className="text-sm font-medium text-gray-700">In Flow of Funds</span>
      </div>

      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium text-gray-700">Corridors</label>
          <button type="button" onClick={addCorridor} className="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
            Add Corridor
          </button>
        </div>
        <div className="space-y-3">
          {formData.corridors.map((corridor, index) => (
            <div key={corridor.id} className="flex gap-2 items-start p-3 bg-gray-50 rounded-lg">
              <div className="flex-1">
                <select
                  value={corridor.currency}
                  onChange={(e) => updateCorridor(corridor.id, 'currency', e.target.value)}
                  className="w-full px-3 py-2.5 bg-[#0c0c0e] border border-[#27272a] text-white text-sm focus:border-[#2970FF] focus:ring-0 outline-none transition-colors"
                >
                  {CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              <div className="flex-1">
                <input
                  type="number"
                  value={corridor.expectedVolume}
                  onChange={(e) => updateCorridor(corridor.id, 'expectedVolume', e.target.value)}
                  placeholder="Volume (USD)"
                  className="w-full px-3 py-2.5 bg-[#0c0c0e] border border-[#27272a] text-white text-sm font-mono focus:border-[#2970FF] focus:ring-0 outline-none transition-colors"
                />
              </div>
              <div className="flex-1">
                <select
                  value={corridor.priority}
                  onChange={(e) => updateCorridor(corridor.id, 'priority', e.target.value)}
                  className="w-full px-3 py-2.5 bg-[#0c0c0e] border border-[#27272a] text-white text-sm focus:border-[#2970FF] focus:ring-0 outline-none transition-colors"
                >
                  {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
                </select>
              </div>
              <button
                type="button"
                onClick={() => removeCorridor(corridor.id)}
                disabled={formData.corridors.length === 1}
                className="p-2 text-slate-300 hover:text-red-500 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          ))}
        </div>
        {Object.keys(errors).filter(k => k.startsWith('corridor_')).map(k => (
          <p key={k} className="text-red-500 text-sm mt-1">{errors[k]}</p>
        ))}
      </div>

      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Sumsub Link</label>
        <input
          type="url"
          value={formData.sumsubLink}
          onChange={(e) => setFormData({ ...formData, sumsubLink: e.target.value })}
          className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all ${errors.sumsubLink ? 'border-red-500' : 'border-gray-300'}`}
          placeholder="https://..."
        />
        {errors.sumsubLink && <p className="text-red-500 text-sm mt-1">{errors.sumsubLink}</p>}
      </div>

      {/* Tags */}
      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Tags</label>
        <div className="space-y-2">
          {/* Current Tags */}
          {(formData.tags || []).length > 0 && (
            <div className="flex flex-wrap gap-2">
              {(formData.tags || []).map((tag, i) => (
                <span key={i} className="inline-flex items-center gap-1 px-2.5 py-1 bg-blue-50 text-blue-700 rounded-full text-sm font-medium">
                  {tag}
                  <button type="button" onClick={() => removeTag(tag)} className="hover:bg-blue-100 rounded-full p-0.5">
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </span>
              ))}
            </div>
          )}
          {/* Tag Input */}
          <div className="flex gap-2">
            <input
              type="text"
              value={tagInput}
              onChange={(e) => setTagInput(e.target.value)}
              onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); addTag(tagInput); } }}
              className="flex-1 px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-blue-500 outline-none"
              placeholder="Type a tag and press Enter..."
            />
          </div>
          {/* Suggested Tags */}
          <div className="flex flex-wrap gap-1">
            <span className="text-xs text-slate-300 mr-1">Suggestions:</span>
            {SUGGESTED_TAGS.filter(t => !(formData.tags || []).includes(t)).slice(0, 5).map(tag => (
              <button
                key={tag}
                type="button"
                onClick={() => addTag(tag)}
                className="px-2 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-full transition-colors"
              >
                + {tag}
              </button>
            ))}
          </div>
        </div>
      </div>

      <div>
        <label className="block text-[10px] font-bold uppercase tracking-wider text-[#71717a] mb-2">Notes</label>
        <textarea
          value={formData.notes}
          onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
          rows={3}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
          placeholder="Optional notes..."
        />
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t border-[#27272a]">
        <button type="button" onClick={onClose} className="px-4 py-2.5 bg-[#27272a] border border-[#3f3f46] text-[#a1a1aa] text-xs font-bold uppercase tracking-wider hover:border-white hover:text-white transition-colors">
          Cancel
        </button>
        <button type="submit" className="btn-primary px-5 py-2.5">
          {client ? 'Update Client' : 'Add Client'}
        </button>
      </div>
    </form>
  );
}

// Stats Bar Component
function StatsBar({ clients, onFilterClick, activeFilter }) {
  const stats = useMemo(() => {
    const kybCounts = KYB_STATUSES.reduce((acc, s) => ({ ...acc, [s]: 0 }), {});
    let totalVolume = 0;
    let highPriority = 0;
    let missingKyb = 0;

    clients.forEach(c => {
      kybCounts[c.kybStatus]++;
      c.corridors.forEach(cor => {
        totalVolume += cor.expectedVolume || 0;
        if (cor.priority === 'High') highPriority++;
      });
      if (c.kybStatus !== 'Approved') missingKyb++;
    });

    return { total: clients.length, kybCounts, totalVolume, highPriority, missingKyb };
  }, [clients]);

  const formatVolume = (v) => {
    if (v >= 1000000) return `$${(v / 1000000).toFixed(1)}M`;
    if (v >= 1000) return `$${(v / 1000).toFixed(1)}K`;
    return `$${v}`;
  };

  const isActive = (filterValue) => activeFilter === filterValue;

  return (
    <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4 mb-6 animate-slide-up">
      {/* Total Clients */}
      <button onClick={() => onFilterClick('all')} className={`stat-card p-4 text-left cursor-pointer ${!activeFilter ? 'ring-2 ring-[#2970FF] ring-offset-2' : ''}`}>
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-slate-100 dark:bg-zinc-800 flex items-center justify-center">
            <svg className="w-5 h-5 text-slate-600 dark:text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
            </svg>
          </div>
          <div>
            <p className="text-xs text-slate-500 dark:text-zinc-500 font-medium">Clients</p>
            <p className="text-2xl font-bold text-slate-900 dark:text-white">{stats.total}</p>
          </div>
        </div>
      </button>

      {/* Pipeline Volume */}
      <div className="stat-card p-4 col-span-2 bg-gradient-to-br from-[#2970FF] to-[#1a5fe6] border-0">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <p className="text-xs text-white/70 font-medium">Pipeline</p>
            <p className="text-2xl font-bold text-white">{formatVolume(stats.totalVolume)}</p>
          </div>
        </div>
      </div>

      {/* Pending */}
      <button onClick={() => onFilterClick('Pending')} className={`stat-card p-4 text-left cursor-pointer ${isActive('Pending') ? 'ring-2 ring-amber-500 ring-offset-2' : ''}`}>
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-amber-50 dark:bg-amber-900/20 flex items-center justify-center">
            <svg className="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <p className="text-xs text-slate-500 dark:text-zinc-500 font-medium">Pending</p>
            <p className="text-2xl font-bold text-amber-500">{stats.kybCounts['Pending']}</p>
          </div>
        </div>
      </button>

      {/* In Review */}
      <button onClick={() => onFilterClick('In Review')} className={`stat-card p-4 text-left cursor-pointer ${isActive('In Review') ? 'ring-2 ring-blue-500 ring-offset-2' : ''}`}>
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center">
            <svg className="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z" />
            </svg>
          </div>
          <div>
            <p className="text-xs text-slate-500 dark:text-zinc-500 font-medium">In Review</p>
            <p className="text-2xl font-bold text-blue-500">{stats.kybCounts['In Review']}</p>
          </div>
        </div>
      </button>

      {/* Approved */}
      <button onClick={() => onFilterClick('Approved')} className={`stat-card p-4 text-left cursor-pointer ${isActive('Approved') ? 'ring-2 ring-emerald-500 ring-offset-2' : ''}`}>
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 flex items-center justify-center">
            <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <p className="text-xs text-slate-500 dark:text-zinc-500 font-medium">Approved</p>
            <p className="text-2xl font-bold text-emerald-500">{stats.kybCounts['Approved']}</p>
          </div>
        </div>
      </button>

      {/* Rejected */}
      <button onClick={() => onFilterClick('Rejected')} className={`stat-card p-4 text-left cursor-pointer ${isActive('Rejected') ? 'ring-2 ring-red-500 ring-offset-2' : ''}`}>
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-red-50 dark:bg-red-900/20 flex items-center justify-center">
            <svg className="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <p className="text-xs text-slate-500 dark:text-zinc-500 font-medium">Rejected</p>
            <p className="text-2xl font-bold text-red-500">{stats.kybCounts['Rejected']}</p>
          </div>
        </div>
      </button>

      {/* Needs KYB */}
      <button onClick={() => onFilterClick('missing')} className={`stat-card p-4 text-left cursor-pointer ${isActive('missing') ? 'ring-2 ring-orange-500 ring-offset-2' : ''}`}>
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-orange-50 dark:bg-orange-900/20 flex items-center justify-center">
            <svg className="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
            </svg>
          </div>
          <div>
            <p className="text-xs text-slate-500 dark:text-zinc-500 font-medium">Needs KYB</p>
            <p className="text-2xl font-black font-mono text-violet-500">{stats.missingKyb}</p>
          </div>
        </div>
      </button>
    </div>
  );
}

// Dashboard Component
function Dashboard({ clients }) {
  const kybData = useMemo(() => {
    const counts = {};
    clients.forEach(c => {
      counts[c.kybStatus] = (counts[c.kybStatus] || 0) + 1;
    });
    return KYB_STATUSES.map((status, i) => ({
      name: status,
      value: counts[status] || 0,
      color: CHART_COLORS[i]
    })).filter(d => d.value > 0);
  }, [clients]);

  const corridorData = useMemo(() => {
    const volumes = {};
    clients.forEach(c => {
      c.corridors.forEach(cor => {
        volumes[cor.currency] = (volumes[cor.currency] || 0) + (cor.expectedVolume || 0);
      });
    });
    return Object.entries(volumes)
      .map(([currency, volume]) => ({ currency, volume }))
      .sort((a, b) => b.volume - a.volume)
      .slice(0, 5);
  }, [clients]);

  const missingKyb = useMemo(() => {
    return clients.filter(c => c.kybStatus !== 'Approved');
  }, [clients]);

  const formatVolume = (v) => {
    if (v >= 1000000) return `$${(v / 1000000).toFixed(1)}M`;
    if (v >= 1000) return `$${(v / 1000).toFixed(0)}K`;
    return `$${v}`;
  };

  return (
    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
      <div className="glass-card p-6">
        <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">KYB Status Breakdown</h3>
        {kybData.length > 0 ? (
          <ResponsiveContainer width="100%" height={250}>
            <PieChart>
              <Pie
                data={kybData}
                cx="50%"
                cy="50%"
                innerRadius={60}
                outerRadius={90}
                paddingAngle={2}
                dataKey="value"
                label={({ name, value }) => `${name}: ${value}`}
              >
                {kybData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
              </Pie>
              <Tooltip />
            </PieChart>
          </ResponsiveContainer>
        ) : (
          <div className="h-[250px] flex items-center justify-center text-gray-400 dark:text-zinc-500">No data available</div>
        )}
      </div>

      <div className="glass-card p-6">
        <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Top Corridors by Volume</h3>
        {corridorData.length > 0 ? (
          <ResponsiveContainer width="100%" height={250}>
            <BarChart data={corridorData} layout="vertical">
              <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" className="dark:stroke-zinc-700" />
              <XAxis type="number" tickFormatter={formatVolume} stroke="#64748b" className="dark:stroke-zinc-400" />
              <YAxis type="category" dataKey="currency" width={100} stroke="#64748b" className="dark:stroke-zinc-400" />
              <Tooltip formatter={(value) => formatVolume(value)} />
              <Bar dataKey="volume" fill="#2970FF" radius={[0, 4, 4, 0]} />
            </BarChart>
          </ResponsiveContainer>
        ) : (
          <div className="h-[250px] flex items-center justify-center text-gray-400 dark:text-zinc-500">No data available</div>
        )}
      </div>

      <div className="glass-card p-6 md:col-span-2 lg:col-span-1">
        <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Missing KYB Approval ({missingKyb.length})</h3>
        <div className="space-y-2 max-h-[220px] overflow-y-auto">
          {missingKyb.length > 0 ? missingKyb.map(client => (
            <div key={client.id} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-zinc-800 rounded-lg">
              <span className="font-medium text-gray-700 dark:text-zinc-300 truncate">{client.name}</span>
              <span className={`px-2 py-1 text-xs rounded-full ${KYB_COLORS[client.kybStatus].bg} ${KYB_COLORS[client.kybStatus].text}`}>
                {client.kybStatus}
              </span>
            </div>
          )) : (
            <div className="text-center py-8 text-gray-400 dark:text-zinc-500">All clients approved!</div>
          )}
        </div>
      </div>
    </div>
  );
}

// Main App Component
function App({ currentUser }) {
  const handleLogout = async () => {
    try {
      await auth.signOut();
    } catch (err) {
      console.error('Logout error:', err);
    }
  };
  // Main view mode: 'clients' or 'referrals'
  const [viewMode, setViewMode] = useState('clients');

  // Loading state for initial data fetch
  const [isLoading, setIsLoading] = useState(true);

  // Client state - initialized empty, populated by Firestore subscription
  const [clients, setClients] = useState([]);
  const [showDashboard, setShowDashboard] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [editingClient, setEditingClient] = useState(null);
  const [deleteTarget, setDeleteTarget] = useState(null);
  const [toast, setToast] = useState(null);
  const [search, setSearch] = useState('');
  const [filters, setFilters] = useState({ kybStatus: '', type: '', priority: '' });
  const [activeStatFilter, setActiveStatFilter] = useState(null);
  const [selectedClient, setSelectedClient] = useState(null); // For detail sidebar
  const [deletedClient, setDeletedClient] = useState(null); // For undo functionality
  const [showCommandPalette, setShowCommandPalette] = useState(false); // Cmd+K palette
  const [selectedClients, setSelectedClients] = useState([]); // For bulk actions
  const [darkMode, setDarkMode] = useState(() => {
    try { return JSON.parse(localStorage.getItem('darkMode')) || false; } catch { return false; }
  }); // Dark mode toggle
  const [showKanban, setShowKanban] = useState(false); // Kanban board view
  const [contextMenu, setContextMenu] = useState(null); // Right-click context menu
  const [selectedReferrals, setSelectedReferrals] = useState([]); // For bulk actions on referrals
  const [referralContextMenu, setReferralContextMenu] = useState(null); // Right-click for referrals
  const [pinnedClients, setPinnedClients] = useState(() => {
    try { return JSON.parse(localStorage.getItem('pinnedClients')) || []; } catch { return []; }
  }); // Pinned/favorite clients
  const [quickFilter, setQuickFilter] = useState(null); // Quick filter: 'recent', 'highPriority', 'needsAttention', 'pinned'
  const [showBulkConfirm, setShowBulkConfirm] = useState(null); // Bulk action confirmation modal
  const [visibleColumns, setVisibleColumns] = useState(() => {
    try { return JSON.parse(localStorage.getItem('visibleColumns')) || ['name', 'type', 'flowOfFunds', 'corridors', 'volume', 'kybStatus', 'sumsub', 'actions']; } catch { return ['name', 'type', 'flowOfFunds', 'corridors', 'volume', 'kybStatus', 'sumsub', 'actions']; }
  }); // Column visibility
  const [showColumnSettings, setShowColumnSettings] = useState(false);
  const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'asc' });
  const [networkViewAggregator, setNetworkViewAggregator] = useState(null);

  // Referral state - initialized empty, populated by Firestore subscription
  const [referrers, setReferrers] = useState([]);
  const [referrals, setReferrals] = useState([]);
  const [showReferrerModal, setShowReferrerModal] = useState(false);
  const [showReferralModal, setShowReferralModal] = useState(false);
  const [editingReferrer, setEditingReferrer] = useState(null);
  const [editingReferral, setEditingReferral] = useState(null);
  const [deleteReferrerTarget, setDeleteReferrerTarget] = useState(null);
  const [deleteReferralTarget, setDeleteReferralTarget] = useState(null);
  const [referralSearch, setReferralSearch] = useState('');
  const [referralFilters, setReferralFilters] = useState({ status: '', referrerId: '' });
  const [referralSortConfig, setReferralSortConfig] = useState({ key: 'referredCompany', direction: 'asc' });
  const [networkViewReferrer, setNetworkViewReferrer] = useState(null);

  // Grouped view state for hierarchical display
  const [clientsGroupedView, setClientsGroupedView] = useState(false);
  const [referralsGroupedView, setReferralsGroupedView] = useState(false);
  const [expandedAggregators, setExpandedAggregators] = useState(new Set());
  const [expandedReferrers, setExpandedReferrers] = useState(new Set());

  // Toggle expand/collapse for aggregators
  const toggleAggregatorExpanded = (aggregatorId) => {
    setExpandedAggregators(prev => {
      const newSet = new Set(prev);
      if (newSet.has(aggregatorId)) {
        newSet.delete(aggregatorId);
      } else {
        newSet.add(aggregatorId);
      }
      return newSet;
    });
  };

  // Toggle expand/collapse for referrers
  const toggleReferrerExpanded = (referrerId) => {
    setExpandedReferrers(prev => {
      const newSet = new Set(prev);
      if (newSet.has(referrerId)) {
        newSet.delete(referrerId);
      } else {
        newSet.add(referrerId);
      }
      return newSet;
    });
  };

  // Expand/collapse all aggregators
  const toggleAllAggregators = (expand) => {
    if (expand) {
      const allAggregatorIds = clients.filter(c => c.type === 'Aggregator').map(c => c.id);
      setExpandedAggregators(new Set(allAggregatorIds));
    } else {
      setExpandedAggregators(new Set());
    }
  };

  // Expand/collapse all referrers
  const toggleAllReferrers = (expand) => {
    if (expand) {
      const allReferrerIds = referrers.map(r => r.id);
      setExpandedReferrers(new Set(allReferrerIds));
    } else {
      setExpandedReferrers(new Set());
    }
  };

  // Get sub-merchants for an aggregator
  const getSubMerchants = (aggregatorId) => {
    return clients.filter(c => c.parentAggregatorId === aggregatorId);
  };

  // Get referrals for a referrer
  const getReferralsForReferrer = (referrerId) => {
    return referrals.filter(r => r.referrerId === referrerId);

        // Get total volume for a client (for aggregators, sum of sub-merchant volumes)
        const getClientVolume = (client) => {
                if (client.type === 'Aggregator') {
                          const subMerchants = getSubMerchants(client.id);
                          return subMerchants.reduce((sum, sm) => 
                                      sum + sm.corridors.reduce((s, c) => s + (c.expectedVolume || 0), 0), 0);
                }
                return client.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0);
        };
  };

  // Persist dark mode preference
  useEffect(() => {
    localStorage.setItem('darkMode', JSON.stringify(darkMode));
  }, [darkMode]);

  // Subscribe to Firestore collections for real-time sync
  useEffect(() => {
    let loadedCount = 0;
    const checkLoaded = () => {
      loadedCount++;
      if (loadedCount >= 3) setIsLoading(false);
    };

    // Subscribe to clients collection
    const unsubClients = firestoreUtils.subscribe('clients', (data) => {
      setClients(data);
      checkLoaded();
    });

    // Subscribe to referrers collection
    const unsubReferrers = firestoreUtils.subscribe('referrers', (data) => {
      setReferrers(data);
      checkLoaded();
    });

    // Subscribe to referrals collection
    const unsubReferrals = firestoreUtils.subscribe('referrals', (data) => {
      setReferrals(data);
      checkLoaded();
    });

    // Cleanup subscriptions on unmount
    return () => {
      unsubClients();
      unsubReferrers();
      unsubReferrals();
    };
  }, []);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyboard = (e) => {
      // Ctrl/Cmd + N: Add new
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        if (viewMode === 'clients') {
          setEditingClient(null);
          setShowModal(true);
        } else {
          setEditingReferral(null);
          setShowReferralModal(true);
        }
      }
      // Ctrl/Cmd + D: Toggle dashboard
      if ((e.ctrlKey || e.metaKey) && e.key === 'd' && viewMode === 'clients') {
        e.preventDefault();
        setShowDashboard(prev => !prev);
      }
      // Escape: Close modals/sidebars
      if (e.key === 'Escape') {
        setShowModal(false);
        setShowReferralModal(false);
        setShowReferrerModal(false);
        setSelectedClient(null);
        setNetworkViewAggregator(null);
        setNetworkViewReferrer(null);
        setShowCommandPalette(false);
      }
      // Ctrl/Cmd + F: Focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.querySelector('input[placeholder*="Search"]');
        if (searchInput) searchInput.focus();
      }
      // Ctrl/Cmd + K: Open command palette
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        setShowCommandPalette(true);
      }
    };
    document.addEventListener('keydown', handleKeyboard);
    return () => document.removeEventListener('keydown', handleKeyboard);
  }, [viewMode]);

  const showToast = (message, type = 'success') => {
    setToast({ message, type });
  };

  // Handle stat card filter clicks
  const handleStatFilterClick = (filterType) => {
    if (filterType === 'all') {
      setFilters({ kybStatus: '', type: '', priority: '' });
      setActiveStatFilter(null);
    } else if (filterType === 'missing') {
      setFilters({ kybStatus: '', type: '', priority: '' });
      setActiveStatFilter('missing');
    } else {
      if (activeStatFilter === filterType) {
        setFilters({ ...filters, kybStatus: '' });
        setActiveStatFilter(null);
      } else {
        setFilters({ ...filters, kybStatus: filterType });
        setActiveStatFilter(filterType);
      }
    }
    setShowDashboard(false);
  };

  // Export to CSV function
  const exportToCSV = () => {
    const headers = ['Name', 'Type', 'KYB Status', 'In Flow of Funds', 'Corridors', 'Total Volume', 'Sumsub Link', 'Notes', 'Tags'];
    const rows = sortedClients.map(client => [
      client.name,
      client.type,
      client.kybStatus,
      client.inFlowOfFunds ? 'Yes' : 'No',
      client.corridors.map(c => `${c.currency} (${c.priority})`).join('; '),
      client.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0),
      client.sumsubLink || '',
      client.notes || '',
      (client.tags || []).join('; ')
    ]);

    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `clients-export-${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast('Exported ' + sortedClients.length + ' clients to CSV');
  };

  // Toggle dark mode
  const toggleDarkMode = () => {
    setDarkMode(!darkMode);
    document.documentElement.classList.toggle('dark');
  };

  // Update KYB status (for Kanban drag-drop)
  const handleUpdateKybStatus = async (clientId, newStatus) => {
    try {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      const updatedClient = { ...client, kybStatus: newStatus };
      await firestoreUtils.save('clients', updatedClient);
      window.syncToGoogleSheets('edit', 'Clients', { ...updatedClient });
      showToast(`Moved to ${newStatus}`);
    } catch (error) {
      showToast('Error updating status: ' + error.message, 'error');
    }
  };

  // Bulk actions handlers
  const handleBulkDelete = async () => {
    if (selectedClients.length === 0) return;
    try {
      for (const clientId of selectedClients) {
        await firestoreUtils.delete('clients', clientId);
      }
      showToast(`Deleted ${selectedClients.length} clients`);
      setSelectedClients([]);
    } catch (error) {
      showToast('Error deleting clients: ' + error.message, 'error');
    }
  };

  const handleBulkStatusChange = async (newStatus) => {
    if (selectedClients.length === 0) return;
    try {
      for (const clientId of selectedClients) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
          await firestoreUtils.save('clients', { ...client, kybStatus: newStatus });
        }
      }
      showToast(`Updated ${selectedClients.length} clients to ${newStatus}`);
      setSelectedClients([]);
    } catch (error) {
      showToast('Error updating clients: ' + error.message, 'error');
    }
  };

  const toggleClientSelection = (clientId) => {
    setSelectedClients(prev =>
      prev.includes(clientId)
        ? prev.filter(id => id !== clientId)
        : [...prev, clientId]
    );
  };

  const toggleSelectAll = () => {
    if (selectedClients.length === sortedClients.length) {
      setSelectedClients([]);
    } else {
      setSelectedClients(sortedClients.map(c => c.id));
    }
  };

  // Inline edit handler
  const handleInlineEdit = async (clientId, field, newValue) => {
    try {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      const updatedClient = { ...client, [field]: newValue };
      await firestoreUtils.save('clients', updatedClient);
      window.syncToGoogleSheets('edit', 'Clients', { ...updatedClient });
      showToast('Updated successfully');
    } catch (error) {
      showToast('Error updating: ' + error.message, 'error');
    }
  };

  // Right-click context menu handler
  const handleContextMenu = (e, client) => {
    e.preventDefault();
    e.stopPropagation();
    setContextMenu({ x: e.clientX, y: e.clientY, client });
  };

  // Referral bulk actions
  const toggleReferralSelection = (referralId) => {
    setSelectedReferrals(prev =>
      prev.includes(referralId)
        ? prev.filter(id => id !== referralId)
        : [...prev, referralId]
    );
  };

  const toggleSelectAllReferrals = () => {
    if (selectedReferrals.length === sortedReferrals.length) {
      setSelectedReferrals([]);
    } else {
      setSelectedReferrals(sortedReferrals.map(r => r.id));
    }
  };

  const handleBulkDeleteReferrals = async () => {
    if (selectedReferrals.length === 0) return;
    try {
      for (const referralId of selectedReferrals) {
        await firestoreUtils.delete('referrals', referralId);
      }
      showToast(`Deleted ${selectedReferrals.length} referrals`);
      setSelectedReferrals([]);
    } catch (error) {
      showToast('Error deleting referrals: ' + error.message, 'error');
    }
  };

  const handleBulkReferralStatusChange = async (newStatus) => {
    if (selectedReferrals.length === 0) return;
    try {
      for (const referralId of selectedReferrals) {
        const referral = referrals.find(r => r.id === referralId);
        if (referral) {
          await firestoreUtils.save('referrals', { ...referral, status: newStatus });
        }
      }
      showToast(`Updated ${selectedReferrals.length} referrals to ${newStatus}`);
      setSelectedReferrals([]);
    } catch (error) {
      showToast('Error updating referrals: ' + error.message, 'error');
    }
  };

  // Export referrals to CSV
  const exportReferralsToCSV = () => {
    const headers = ['Referred Company', 'Referrer', 'Status', 'Currencies', 'Fee Split', 'Notes'];
    const rows = sortedReferrals.map(referral => {
      const referrer = referrers.find(r => r.id === referral.referrerId);
      return [
        referral.referredCompany,
        referrer?.name || 'Unknown',
        referral.status,
        referral.currencies.map(c => `${c.currency}: ${c.costPercentage}%`).join('; '),
        referrer?.feeSplitPercentage ? `${referrer.feeSplitPercentage}%` : 'Not set',
        referral.notes || ''
      ];
    });

    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `referrals-export-${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast('Exported ' + sortedReferrals.length + ' referrals to CSV');
  };

  // Right-click context menu for referrals
  const handleReferralContextMenu = (e, referral) => {
    e.preventDefault();
    e.stopPropagation();
    setReferralContextMenu({ x: e.clientX, y: e.clientY, referral });
  };

  // Update referral status (for context menu)
  const handleUpdateReferralStatus = async (referralId, newStatus) => {
    try {
      const referral = referrals.find(r => r.id === referralId);
      if (!referral) return;
      await firestoreUtils.save('referrals', { ...referral, status: newStatus });
      showToast(`Status updated to ${newStatus}`);
    } catch (error) {
      showToast('Error updating status: ' + error.message, 'error');
    }
  };

  // Pin/Unpin client
  const togglePinClient = (clientId) => {
    const newPinned = pinnedClients.includes(clientId)
      ? pinnedClients.filter(id => id !== clientId)
      : [...pinnedClients, clientId];
    setPinnedClients(newPinned);
    localStorage.setItem('pinnedClients', JSON.stringify(newPinned));
    showToast(pinnedClients.includes(clientId) ? 'Client unpinned' : 'Client pinned ‚≠ê');
  };

  // Toggle column visibility
  const toggleColumn = (column) => {
    const newColumns = visibleColumns.includes(column)
      ? visibleColumns.filter(c => c !== column)
      : [...visibleColumns, column];
    setVisibleColumns(newColumns);
    localStorage.setItem('visibleColumns', JSON.stringify(newColumns));
  };

  // Check for duplicate clients
  const checkDuplicates = (name) => {
    const normalized = name.toLowerCase().trim();
    return clients.filter(c =>
      c.name.toLowerCase().trim() === normalized ||
      c.name.toLowerCase().includes(normalized) ||
      normalized.includes(c.name.toLowerCase())
    );
  };

  // Get quick filtered clients
  const getQuickFilteredClients = useMemo(() => {
    let filtered = [...clients];

    if (quickFilter === 'pinned') {
      filtered = filtered.filter(c => pinnedClients.includes(c.id));
    } else if (quickFilter === 'recent') {
      // Sort by createdAt or id (which has timestamp)
      filtered = filtered.slice().sort((a, b) => (b.id || '').localeCompare(a.id || '')).slice(0, 10);
    } else if (quickFilter === 'highPriority') {
      filtered = filtered.filter(c => c.corridors.some(cor => cor.priority === 'High'));
    } else if (quickFilter === 'needsAttention') {
      filtered = filtered.filter(c => c.kybStatus === 'Pending' || c.kybStatus === 'In Review');
    }

    return filtered;
  }, [clients, quickFilter, pinnedClients]);

  // Column definitions
  const ALL_COLUMNS = [
    { key: 'name', label: 'Client Name' },
    { key: 'type', label: 'Type' },
    { key: 'flowOfFunds', label: 'Flow of Funds' },
    { key: 'corridors', label: 'Corridors' },
    { key: 'volume', label: 'Volume' },
    { key: 'kybStatus', label: 'KYB Status' },
    { key: 'sumsub', label: 'Sumsub' },
    { key: 'actions', label: 'Actions' }
  ];

  const handleSave = async (client) => {
    try {
      if (editingClient) {
        await firestoreUtils.save('clients', client);
        window.syncToGoogleSheets('edit', 'Clients', { ...client });
        showToast('Client updated successfully');
      } else {
        const { id, ...clientData } = client;
        await db.collection('clients').doc(id).set(clientData);
        window.syncToGoogleSheets('add', 'Clients', { id, ...clientData });
        showToast('Client added successfully');
      }
      setShowModal(false);
      setEditingClient(null);
    } catch (error) {
      showToast('Error saving client: ' + error.message, 'error');
    }
  };

  const handleDelete = async () => {
    try {
      // Store for undo
      const clientToDelete = { ...deleteTarget };
      setDeletedClient(clientToDelete);

      await firestoreUtils.delete('clients', deleteTarget.id);
      window.syncToGoogleSheets('delete', 'Clients', { id: deleteTarget.id, name: deleteTarget.name });

      const affectedSubMerchants = clients.filter(c => c.parentAggregatorId === deleteTarget.id);
      for (const subMerchant of affectedSubMerchants) {
        const { id, ...data } = subMerchant;
        await db.collection('clients').doc(id).set({ ...data, parentAggregatorId: '' });
      }

      setDeleteTarget(null);
      // Show undo toast - will be cleared after 5 seconds
      setToast({ message: `Deleted "${clientToDelete.name}"`, type: 'undo', data: clientToDelete });
      setTimeout(() => {
        setDeletedClient(null);
        setToast(null);
      }, 5000);
    } catch (error) {
      showToast('Error deleting client: ' + error.message, 'error');
    }
  };

  const handleUndoDelete = async () => {
    if (!deletedClient) return;
    try {
      const { id, ...clientData } = deletedClient;
      await db.collection('clients').doc(id).set(clientData);
      window.syncToGoogleSheets('add', 'Clients', deletedClient);
      showToast('Client restored!');
      setDeletedClient(null);
    } catch (error) {
      showToast('Error restoring client: ' + error.message, 'error');
    }
  };

  // Referrer handlers
  const handleSaveReferrer = async (referrer) => {
    try {
      if (editingReferrer) {
        await firestoreUtils.save('referrers', referrer);
        window.syncToGoogleSheets('edit', 'Partners', { ...referrer });
        showToast('Partner updated successfully');
      } else {
        const { id, ...referrerData } = referrer;
        await db.collection('referrers').doc(id).set(referrerData);
        window.syncToGoogleSheets('add', 'Partners', { id, ...referrerData });
        showToast('Partner added successfully');
      }
      setShowReferrerModal(false);
      setEditingReferrer(null);
    } catch (error) {
      showToast('Error saving partner: ' + error.message, 'error');
    }
  };

  const handleDeleteReferrer = async () => {
    try {
      const referralsToDelete = referrals.filter(r => r.referrerId === deleteReferrerTarget.id);
      for (const referral of referralsToDelete) {
        await firestoreUtils.delete('referrals', referral.id);
        window.syncToGoogleSheets('delete', 'Referrals', { id: referral.id, clientName: referral.referredCompany });
      }
      await firestoreUtils.delete('referrers', deleteReferrerTarget.id);
      window.syncToGoogleSheets('delete', 'Partners', { id: deleteReferrerTarget.id, name: deleteReferrerTarget.name });
      showToast('Partner deleted successfully');
      setDeleteReferrerTarget(null);
    } catch (error) {
      showToast('Error deleting partner: ' + error.message, 'error');
    }
  };

  // Referral handlers
  const handleSaveReferral = async (referral) => {
    try {
      const referrer = referrers.find(r => r.id === referral.referrerId);
      if (editingReferral) {
        await firestoreUtils.save('referrals', referral);
        window.syncToGoogleSheets('edit', 'Referrals', { ...referral, referrerName: referrer?.name });
        showToast('Referral updated successfully');
      } else {
        const { id, ...referralData } = referral;
        await db.collection('referrals').doc(id).set(referralData);
        window.syncToGoogleSheets('add', 'Referrals', { id, ...referralData, referrerName: referrer?.name });
        showToast('Referral added successfully');
      }
      setShowReferralModal(false);
      setEditingReferral(null);
    } catch (error) {
      showToast('Error saving referral: ' + error.message, 'error');
    }
  };

  const handleDeleteReferral = async () => {
    try {
      await firestoreUtils.delete('referrals', deleteReferralTarget.id);
      window.syncToGoogleSheets('delete', 'Referrals', { id: deleteReferralTarget.id, clientName: deleteReferralTarget.referredCompany });
      showToast('Referral deleted successfully');
      setDeleteReferralTarget(null);
    } catch (error) {
      showToast('Error deleting referral: ' + error.message, 'error');
    }
  };

  const handleExport = () => {
    const headers = ['Name', 'Type', 'In Flow of Funds', 'Corridors', 'Sumsub Link', 'KYB Status', 'Notes', 'Parent Aggregator ID'];
    const rows = clients.map(c => [
      c.name,
      c.type,
      c.inFlowOfFunds ? 'Yes' : 'No',
      c.corridors.map(cor => `${cor.currency}:${cor.expectedVolume}:${cor.priority}`).join('|'),
      c.sumsubLink,
      c.kybStatus,
      c.notes,
      c.parentAggregatorId || ''
    ]);
    const csv = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clients_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported successfully');
  };

  const handleImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (event) => {
      try {
        const lines = event.target.result.split('\n').filter(l => l.trim());
        const newClients = [];
        for (let i = 1; i < lines.length; i++) {
          const values = [];
          let current = '';
          let inQuotes = false;
          for (const char of lines[i]) {
            if (char === '"') inQuotes = !inQuotes;
            else if (char === ',' && !inQuotes) { values.push(current); current = ''; }
            else current += char;
          }
          values.push(current);
          if (values.length >= 6) {
            const corridors = values[3].split('|').filter(c => c).map(c => {
              const [currency, expectedVolume, priority] = c.split(':');
              return { id: generateId(), currency: currency || 'USD', expectedVolume: Number(expectedVolume) || 0, priority: priority || 'Med' };
            });
            newClients.push({
              id: generateId(),
              name: values[0],
              type: values[1] || 'Aggregator',
              inFlowOfFunds: values[2] === 'Yes',
              corridors: corridors.length ? corridors : [{ id: generateId(), currency: 'USD', expectedVolume: 0, priority: 'Med' }],
              sumsubLink: values[4] || '',
              kybStatus: values[5] || 'Pending',
              notes: values[6] || '',
              parentAggregatorId: values[7] || ''
            });
          }
        }
        // Save all new clients to Firestore
        for (const client of newClients) {
          const { id, ...clientData } = client;
          await db.collection('clients').doc(id).set(clientData);
        }
        showToast(`Imported ${newClients.length} clients`);
      } catch (err) {
        console.error('Import error:', err);
        showToast('Failed to import CSV', 'error');
      }
      e.target.value = '';
    };
    reader.readAsText(file);
  };

  const filteredClients = useMemo(() => {
    return clients.filter(c => {
      const searchLower = search.toLowerCase();
      const matchesSearch = !search ||
        c.name.toLowerCase().includes(searchLower) ||
        c.corridors.some(cor => cor.currency.toLowerCase().includes(searchLower));
      const matchesKyb = !filters.kybStatus || c.kybStatus === filters.kybStatus;
      const matchesType = !filters.type || c.type === filters.type;
      const matchesPriority = !filters.priority || c.corridors.some(cor => cor.priority === filters.priority);
      const matchesMissing = activeStatFilter !== 'missing' || c.kybStatus !== 'Approved';
      return matchesSearch && matchesKyb && matchesType && matchesPriority && matchesMissing;
    });
  }, [clients, search, filters, activeStatFilter]);

  const sortedClients = useMemo(() => {
    // Apply quick filter first
    let baseClients = [...filteredClients];
    if (quickFilter === 'pinned') {
      baseClients = baseClients.filter(c => pinnedClients.includes(c.id));
    } else if (quickFilter === 'recent') {
      baseClients = baseClients.slice().sort((a, b) => (b.id || '').localeCompare(a.id || '')).slice(0, 10);
    } else if (quickFilter === 'highPriority') {
      baseClients = baseClients.filter(c => c.corridors.some(cor => cor.priority === 'High'));
    } else if (quickFilter === 'needsAttention') {
      baseClients = baseClients.filter(c => c.kybStatus === 'Pending' || c.kybStatus === 'In Review');
    }

    // Sort pinned clients to top
    const sorted = [...baseClients];
    sorted.sort((a, b) => {
      // Pinned items first (if not already filtered to pinned only)
      if (quickFilter !== 'pinned') {
        const aPinned = pinnedClients.includes(a.id);
        const bPinned = pinnedClients.includes(b.id);
        if (aPinned && !bPinned) return -1;
        if (!aPinned && bPinned) return 1;
      }

      let aVal, bVal;
      switch (sortConfig.key) {
        case 'name': aVal = a.name.toLowerCase(); bVal = b.name.toLowerCase(); break;
        case 'type': aVal = a.type; bVal = b.type; break;
        case 'kybStatus': aVal = KYB_STATUSES.indexOf(a.kybStatus); bVal = KYB_STATUSES.indexOf(b.kybStatus); break;
        case 'volume':
          aVal = a.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0);
          bVal = b.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0);
          break;
        default: return 0;
      }
      if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });
    return sorted;
  }, [filteredClients, sortConfig, quickFilter, pinnedClients]);

  const handleSort = (key) => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  const SortIcon = ({ columnKey }) => {
    if (sortConfig.key !== columnKey) return <span className="text-gray-300 ml-1">‚Üï</span>;
    return <span className="text-blue-600 ml-1">{sortConfig.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>;
  };

  const formatVolume = (v) => {
    if (v >= 1000000) return `$${(v / 1000000).toFixed(1)}M`;
    if (v >= 1000) return `$${(v / 1000).toFixed(1)}K`;
    return `$${v}`;
  };

  // Filtered and sorted referrals
  const filteredReferrals = useMemo(() => {
    return referrals.filter(r => {
      const searchLower = referralSearch.toLowerCase();
      const referrer = referrers.find(ref => ref.id === r.referrerId);
      const matchesSearch = !referralSearch ||
        r.referredCompany.toLowerCase().includes(searchLower) ||
        (referrer && referrer.name.toLowerCase().includes(searchLower));
      const matchesStatus = !referralFilters.status || r.status === referralFilters.status;
      const matchesReferrer = !referralFilters.referrerId || r.referrerId === referralFilters.referrerId;
      return matchesSearch && matchesStatus && matchesReferrer;
    });
  }, [referrals, referrers, referralSearch, referralFilters]);

  const sortedReferrals = useMemo(() => {
    const sorted = [...filteredReferrals];
    sorted.sort((a, b) => {
      let aVal, bVal;
      switch (referralSortConfig.key) {
        case 'referredCompany': aVal = a.referredCompany.toLowerCase(); bVal = b.referredCompany.toLowerCase(); break;
        case 'status': aVal = REFERRAL_STATUSES.indexOf(a.status); bVal = REFERRAL_STATUSES.indexOf(b.status); break;
        case 'referrer':
          const refA = referrers.find(r => r.id === a.referrerId);
          const refB = referrers.find(r => r.id === b.referrerId);
          aVal = refA ? refA.name.toLowerCase() : '';
          bVal = refB ? refB.name.toLowerCase() : '';
          break;
        default: return 0;
      }
      if (aVal < bVal) return referralSortConfig.direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return referralSortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });
    return sorted;
  }, [filteredReferrals, referrers, referralSortConfig]);

  const handleReferralSort = (key) => {
    setReferralSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  const ReferralSortIcon = ({ columnKey }) => {
    if (referralSortConfig.key !== columnKey) return <span className="text-gray-300 ml-1">‚Üï</span>;
    return <span className="text-blue-600 ml-1">{referralSortConfig.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>;
  };

  // Show loading screen while fetching initial data
  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600 font-medium">Loading data...</p>
          <p className="text-slate-300 text-sm mt-1">Syncing with team database</p>
        </div>
      </div>
    );
  }

  return (
    <div className={`min-h-screen geo-bg transition-colors duration-200 ${darkMode ? 'dark' : ''}`}>
      <style>{`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0); } to { opacity: 1; transform: scale(1); } }
        @keyframes drawLine { from { stroke-dashoffset: 200; } to { stroke-dashoffset: 0; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-scale-in { animation: scaleIn 0.15s ease-out; }
        .animate-slide-up { animation: slideUp 0.2s ease-out; }
        .animate-pop-in { animation: popIn 0.3s ease-out backwards; }
        .animate-draw-line { stroke-dasharray: 200; animation: drawLine 0.4s ease-out forwards; }
      `}</style>

      <header className="glass-header sticky top-0 z-30">
        {/* Accent line at top */}
        <div className="accent-line"></div>
        <div className="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
          <div className="flex items-center gap-4">
            {/* SpherePay Logo */}
            <div className="flex items-center gap-3">
              <svg className="h-7" viewBox="0 0 200 38" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="19" cy="19" r="17.5" fill="white" stroke="#e2e8f0" strokeWidth="1"/>
                <defs>
                  <linearGradient id="sphereGrad" x1="6" y1="8" x2="32" y2="36" gradientUnits="userSpaceOnUse">
                    <stop stopColor="#2970FF"/>
                    <stop offset="1" stopColor="#DDEDFF"/>
                  </linearGradient>
                </defs>
                <path d="M19 2C9.06 2 1 10.06 1 20s8.06 18 18 18 18-8.06 18-18S28.94 2 19 2zm16.8 18.8c-.5.9-1.2 1.9-2.2 2.9-2.8 3-7 5.6-11.8 7.3-3.8 1.4-7.6 2.1-11.1 2.1-2.4 0-4.6-.4-6.5-1.4 3.3 4 8.3 6.5 13.8 6.5 10.1 0 18.3-8 18.3-18.1 0-.1 0-.2 0-.3zM19 4c9.9 0 17.9 7.9 17.9 17.7 0 2.1-.4 4.1-1 5.9-.5 1.4-1.6 2.4-3.3 3.2-1.6.7-3.7 1.1-6 1.1-3.1 0-6.7-.6-10.4-2.4-4.6-1.7-8.5-4.2-11-6.8-2.3-2.6-3.4-5.4-2.5-8.4C5.2 7.2 11.7 4.2 19.3 4H19z" fill="url(#sphereGrad)"/>
                <text x="44" y="26" fontFamily="Inter, sans-serif" fontSize="22" fontWeight="800" fill={darkMode ? "#ffffff" : "#1e293b"}>sphere</text>
                <text x="138" y="26" fontFamily="Inter, sans-serif" fontSize="22" fontWeight="800" fill="#2970FF">PAY</text>
              </svg>
              <span className="hidden sm:inline text-xs font-semibold text-[#2970FF] border-l border-gray-200 dark:border-zinc-700 pl-3">Client Manager</span>
            </div>
            {/* Navigation Tabs */}
            <div className="flex bg-gray-100 dark:bg-zinc-800 rounded-lg p-1">
              <button
                onClick={() => setViewMode('clients')}
                className={`px-4 py-2 text-sm font-semibold rounded-md transition-all flex items-center gap-2 ${viewMode === 'clients' ? 'bg-[#2970FF] text-white shadow-sm' : 'text-gray-700 dark:text-zinc-400 hover:text-gray-900 dark:hover:text-white'}`}
              >
                Clients
                <span className={`text-xs font-mono px-1.5 py-0.5 rounded ${viewMode === 'clients' ? 'bg-white/20 text-white' : 'bg-[#2970FF]/10 text-[#2970FF]'}`}>{clients.length}</span>
              </button>
              <button
                onClick={() => setViewMode('referrals')}
                className={`px-4 py-2 text-sm font-semibold rounded-md transition-all flex items-center gap-2 ${viewMode === 'referrals' ? 'bg-[#2970FF] text-white shadow-sm' : 'text-gray-700 dark:text-zinc-400 hover:text-gray-900 dark:hover:text-white'}`}
              >
                Referrals
                <span className={`text-xs font-mono px-1.5 py-0.5 rounded ${viewMode === 'referrals' ? 'bg-white/20 text-white' : 'bg-[#2970FF]/10 text-[#2970FF]'}`}>{referrals.length}</span>
              </button>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {/* Live indicator */}
            <div className="hidden md:flex items-center gap-2 text-xs text-gray-500 dark:text-zinc-400 px-3 py-1.5 bg-gray-50 dark:bg-zinc-800 rounded-full border border-gray-200 dark:border-zinc-700">
              <span className="relative flex h-2 w-2">
                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"></span>
                <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
              </span>
              <span className="font-medium">Live</span>
            </div>
            {/* Dark mode toggle */}
            <button
              onClick={() => setDarkMode(!darkMode)}
              className="p-2 rounded-lg text-gray-500 dark:text-zinc-400 hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors"
              title={darkMode ? "Switch to light mode" : "Switch to dark mode"}
            >
              {darkMode ? (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
              ) : (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
              )}
            </button>
            {/* User info and logout */}
            <div className="flex items-center gap-2 pl-2 border-l border-gray-200 dark:border-zinc-700">
              <img
                src={currentUser?.photoURL || 'https://www.gravatar.com/avatar/?d=mp'}
                alt={currentUser?.displayName || 'User'}
                className="w-8 h-8 rounded-full border-2 border-gray-200 dark:border-zinc-700"
              />
              <span className="hidden sm:inline text-sm font-medium text-gray-700 dark:text-zinc-300">{currentUser?.email?.split('@')[0]}</span>
              <button
                onClick={handleLogout}
                className="p-1.5 rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                title="Sign out"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
              </button>
            </div>
            {viewMode === 'clients' ? (
              <>
                {/* View Toggle Buttons */}
                <div className="hidden sm:flex bg-gray-100 dark:bg-zinc-800 rounded-lg p-1 border border-gray-200 dark:border-zinc-700">
                  <button
                    onClick={() => { setShowDashboard(false); setShowKanban && setShowKanban(false); }}
                    className={`px-3 py-1.5 rounded-md text-xs font-semibold transition-all ${!showDashboard && !showKanban ? 'bg-[#2970FF] text-white shadow-sm' : 'text-gray-500 dark:text-zinc-400 hover:text-gray-900 dark:hover:text-white'}`}
                    title="Table View"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                  </button>
                  <button
                    onClick={() => { setShowKanban(true); setShowDashboard(false); }}
                    className={`px-3 py-1.5 rounded-md text-xs font-semibold transition-all ${showKanban ? 'bg-[#2970FF] text-white shadow-sm' : 'text-gray-500 dark:text-zinc-400 hover:text-gray-900 dark:hover:text-white'}`}
                    title="Kanban Board"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
                    </svg>
                  </button>
                  <button
                    onClick={() => { setShowDashboard(true); setShowKanban(false); }}
                    className={`px-3 py-1.5 rounded-md text-xs font-semibold transition-all ${showDashboard ? 'bg-[#2970FF] text-white shadow-sm' : 'text-gray-500 dark:text-zinc-400 hover:text-gray-900 dark:hover:text-white'}`}
                    title="Analytics"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                  </button>
                </div>
                <button
                  onClick={() => { setEditingClient(null); setShowModal(true); }}
                  className="btn-primary px-5 py-2.5 flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="square" strokeLinejoin="miter" strokeWidth={3} d="M12 4v16m8-8H4" />
                  </svg>
                  <span className="hidden sm:inline">Add Client</span>
                </button>
              </>
            ) : (
              <>
                <button
                  onClick={() => { setEditingReferrer(null); setShowReferrerModal(true); }}
                  className="px-5 py-2.5 bg-gray-100 dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 text-gray-700 dark:text-white text-xs font-semibold rounded-lg hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
                  </svg>
                  Add Partner
                </button>
                <button
                  onClick={() => { setEditingReferral(null); setShowReferralModal(true); }}
                  className="btn-primary px-5 py-2.5 flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="square" strokeLinejoin="miter" strokeWidth={3} d="M12 4v16m8-8H4" />
                  </svg>
                  Add New Client
                </button>
              </>
            )}
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 py-6">
        {viewMode === 'clients' && <StatsBar clients={clients} onFilterClick={handleStatFilterClick} activeFilter={activeStatFilter} />}
        {viewMode === 'referrals' && <ReferralStatsBar referrers={referrers} referrals={referrals} />}

        {viewMode === 'clients' && showDashboard && (
          <Dashboard clients={clients} />
        )}

        {/* Kanban Board View */}
        {viewMode === 'clients' && showKanban && !showDashboard && (
          <div className="animate-fade-in">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-white flex items-center gap-2">
                <svg className="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
                </svg>
                KYB Pipeline
              </h2>
              <p className="text-slate-300 text-sm">Drag clients between columns to update status</p>
            </div>
            <KanbanBoard
              clients={clients}
              onUpdateStatus={handleUpdateKybStatus}
              onSelectClient={(client) => setSelectedClient(client)}
              formatVolume={formatVolume}
            />
          </div>
        )}

        {viewMode === 'clients' && !showDashboard && !showKanban && (
          <div className="glass-card animate-fade-in overflow-hidden">
            {/* Active filter indicator - sharp style */}
            {activeStatFilter && (
              <div className="px-4 py-3 bg-[#2970FF]/10 border-b border-[#2970FF]/30 flex items-center justify-between">
                <div className="flex items-center gap-2 text-sm text-[#2970FF] dark:text-[#84ADFF]">
                  <div className="w-6 h-6 bg-[#2970FF] rounded-md flex items-center justify-center">
                    <svg className="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                  </div>
                  <span className="text-xs font-semibold">Filtering: <strong className="text-gray-900 dark:text-white">{activeStatFilter === 'missing' ? 'Needs KYB Approval' : activeStatFilter}</strong></span>
                  <span className="px-2 py-1 bg-[#2970FF]/20 text-[#2970FF] dark:text-[#84ADFF] text-[10px] font-bold rounded-md">{sortedClients.length} results</span>
                </div>
                <button
                  onClick={() => handleStatFilterClick('all')}
                  className="text-gray-500 dark:text-[#71717a] hover:text-gray-900 dark:hover:text-white text-xs font-semibold flex items-center gap-1 hover:bg-gray-100 dark:hover:bg-[#27272a] px-3 py-1.5 rounded-md transition-colors"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  Clear
                </button>
              </div>
            )}
            <div className="p-4 border-b border-gray-200 dark:border-zinc-700 flex flex-wrap gap-3 items-center" style={{ background: darkMode ? '#0c0c0e' : '#ffffff' }}>
              <div className="flex-1 min-w-[200px]">
                <div className="relative">
                  <svg className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 dark:text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <input
                    type="text"
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    placeholder="Search by name or currency... (‚åò)"
                    className="w-full pl-10 pr-4 py-2.5 rounded-lg text-sm focus:ring-0 outline-none transition-colors"
                    style={{
                      background: darkMode ? '#18181b' : '#f9fafb',
                      border: `1px solid ${darkMode ? '#27272a' : '#e5e7eb'}`,
                      color: darkMode ? '#ffffff' : '#111827'
                    }}
                  />
                </div>
              </div>
              {/* Quick Filters */}
              <div className="flex gap-1">
                <button
                  onClick={() => setQuickFilter(quickFilter === 'pinned' ? null : 'pinned')}
                  className={`px-3 py-2 text-xs font-semibold flex items-center gap-1.5 rounded-md transition-colors ${quickFilter === 'pinned' ? 'bg-[#2970FF] text-white border-[#2970FF]' : ''}`}
                  style={quickFilter !== 'pinned' ? { background: darkMode ? '#18181b' : '#ffffff', border: `1px solid ${darkMode ? '#27272a' : '#e5e7eb'}`, color: darkMode ? '#a1a1aa' : '#4b5563' } : {}}
                >
                  <span>‚≠ê</span> Pinned {pinnedClients.length > 0 && `(${pinnedClients.length})`}
                </button>
                <button
                  onClick={() => setQuickFilter(quickFilter === 'recent' ? null : 'recent')}
                  className={`px-3 py-2 text-xs font-semibold flex items-center gap-1.5 rounded-md transition-colors ${quickFilter === 'recent' ? 'bg-[#2970FF] text-white border-[#2970FF]' : ''}`}
                  style={quickFilter !== 'recent' ? { background: darkMode ? '#18181b' : '#ffffff', border: `1px solid ${darkMode ? '#27272a' : '#e5e7eb'}`, color: darkMode ? '#a1a1aa' : '#4b5563' } : {}}
                >
                  <span>üïê</span> Recent
                </button>
                <button
                  onClick={() => setQuickFilter(quickFilter === 'highPriority' ? null : 'highPriority')}
                  className={`px-3 py-2 text-xs font-semibold flex items-center gap-1.5 rounded-md transition-colors ${quickFilter === 'highPriority' ? 'bg-[#2970FF] text-white border-[#2970FF]' : ''}`}
                  style={quickFilter !== 'highPriority' ? { background: darkMode ? '#18181b' : '#ffffff', border: `1px solid ${darkMode ? '#27272a' : '#e5e7eb'}`, color: darkMode ? '#a1a1aa' : '#4b5563' } : {}}
                >
                  <span>üî•</span> High Priority
                </button>
                <button
                  onClick={() => setQuickFilter(quickFilter === 'needsAttention' ? null : 'needsAttention')}
                  className={`px-3 py-2 text-xs font-semibold flex items-center gap-1.5 rounded-md transition-colors ${quickFilter === 'needsAttention' ? 'bg-[#2970FF] text-white border-[#2970FF]' : ''}`}
                  style={quickFilter !== 'needsAttention' ? { background: darkMode ? '#18181b' : '#ffffff', border: `1px solid ${darkMode ? '#27272a' : '#e5e7eb'}`, color: darkMode ? '#a1a1aa' : '#4b5563' } : {}}
                >
                  <span>üëÄ</span> Needs KYB
                </button>
              </div>
              <select
                value={filters.kybStatus}
                onChange={(e) => {
                  setFilters({ ...filters, kybStatus: e.target.value });
                  setActiveStatFilter(e.target.value || null);
                }}
                className="px-3 py-2.5 rounded-lg text-xs font-semibold uppercase tracking-wide outline-none cursor-pointer"
                style={{
                  background: darkMode ? '#18181b' : '#f9fafb',
                  border: `1px solid ${darkMode ? '#27272a' : '#e5e7eb'}`,
                  color: darkMode ? '#ffffff' : '#374151'
                }}
              >
                <option value="">All Status</option>
                {KYB_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
              </select>
              <select
                value={filters.type}
                onChange={(e) => setFilters({ ...filters, type: e.target.value })}
                className="px-3 py-2.5 rounded-lg text-xs font-semibold uppercase tracking-wide outline-none cursor-pointer"
                style={{
                  background: darkMode ? '#18181b' : '#f9fafb',
                  border: `1px solid ${darkMode ? '#27272a' : '#e5e7eb'}`,
                  color: darkMode ? '#ffffff' : '#374151'
                }}
              >
                <option value="">All Types</option>
                {CLIENT_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
              <select
                value={filters.priority}
                onChange={(e) => setFilters({ ...filters, priority: e.target.value })}
                className="px-3 py-2.5 rounded-lg text-xs font-semibold uppercase tracking-wide outline-none cursor-pointer"
                style={{
                  background: darkMode ? '#18181b' : '#f9fafb',
                  border: `1px solid ${darkMode ? '#27272a' : '#e5e7eb'}`,
                  color: darkMode ? '#ffffff' : '#374151'
                }}
              >
                <option value="">All Priorities</option>
                {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
              </select>
              <div className="flex gap-2">
                <button
                  onClick={handleExport}
                  className="px-4 py-2.5 rounded-lg text-xs font-semibold uppercase tracking-wide hover:border-[#2970FF] hover:text-[#2970FF] transition-colors flex items-center gap-2"
                  style={{
                    background: darkMode ? '#27272a' : '#ffffff',
                    border: `1px solid ${darkMode ? '#3f3f46' : '#e5e7eb'}`,
                    color: darkMode ? '#a1a1aa' : '#4b5563'
                  }}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                  </svg>
                  Export
                </button>
                <label
                  className="px-4 py-2.5 rounded-lg text-xs font-semibold uppercase tracking-wide hover:border-[#2970FF] hover:text-[#2970FF] transition-colors flex items-center gap-2 cursor-pointer"
                  style={{
                    background: darkMode ? '#27272a' : '#ffffff',
                    border: `1px solid ${darkMode ? '#3f3f46' : '#e5e7eb'}`,
                    color: darkMode ? '#a1a1aa' : '#4b5563'
                  }}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  Import
                  <input type="file" accept=".csv" onChange={handleImport} className="hidden" />
                </label>
                <div className="relative">
                  <button
                    onClick={() => setShowColumnSettings(!showColumnSettings)}
                    className="px-3 py-2.5 rounded-lg hover:border-[#2970FF] hover:text-[#2970FF] transition-colors flex items-center gap-2"
                    title="Column settings"
                    style={{
                      background: darkMode ? '#27272a' : '#ffffff',
                      border: `1px solid ${darkMode ? '#3f3f46' : '#e5e7eb'}`,
                      color: darkMode ? '#a1a1aa' : '#4b5563'
                    }}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                  </button>
                  {showColumnSettings && (
                    <ColumnSettings
                      columns={ALL_COLUMNS}
                      visibleColumns={visibleColumns}
                      onToggle={toggleColumn}
                      onClose={() => setShowColumnSettings(false)}
                    />
                  )}
                </div>
                {/* Grouped View Toggle */}
                <button
                  onClick={() => setClientsGroupedView(!clientsGroupedView)}
                  className={`px-3 py-2.5 rounded-lg transition-colors flex items-center gap-2 text-xs font-semibold ${clientsGroupedView ? 'bg-[#2970FF] text-white' : ''}`}
                  title={clientsGroupedView ? "Switch to flat view" : "Group by Aggregator"}
                  style={!clientsGroupedView ? {
                    background: darkMode ? '#27272a' : '#ffffff',
                    border: `1px solid ${darkMode ? '#3f3f46' : '#e5e7eb'}`,
                    color: darkMode ? '#a1a1aa' : '#4b5563'
                  } : {}}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                  {clientsGroupedView ? 'Grouped' : 'Group'}
                </button>
              </div>
            </div>

            {/* Bulk Actions Bar */}
            {selectedClients.length > 0 && (
              <div className="px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-600 flex items-center justify-between">
                <div className="flex items-center gap-3 text-white">
                  <span className="font-semibold">{selectedClients.length} selected</span>
                  <button
                    onClick={() => setSelectedClients([])}
                    className="text-white/80 hover:text-white text-sm underline"
                  >
                    Clear selection
                  </button>
                </div>
                <div className="flex items-center gap-2">
                  <select
                    onChange={(e) => { if (e.target.value) { handleBulkStatusChange(e.target.value); e.target.value = ''; } }}
                    className="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white border border-white/30 focus:outline-none"
                  >
                    <option value="">Change Status...</option>
                    {KYB_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                  <button
                    onClick={handleBulkDelete}
                    className="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium flex items-center gap-1"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                  </button>
                </div>
              </div>
            )}

            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 dark:bg-zinc-900 border-b border-gray-200 dark:border-zinc-700">
                  <tr>
                    <th className="px-3 py-3 text-left">
                      <input
                        type="checkbox"
                        checked={selectedClients.length === sortedClients.length && sortedClients.length > 0}
                        onChange={toggleSelectAll}
                        className="w-4 h-4 rounded border-gray-300 text-[#2970FF] focus:ring-[#2970FF]"
                      />
                    </th>
                    <th onClick={() => handleSort('name')} className="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-zinc-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-800">
                      Client Name <SortIcon columnKey="name" />
                    </th>
                    <th onClick={() => handleSort('type')} className="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-zinc-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-800">
                      Type <SortIcon columnKey="type" />
                    </th>
                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-zinc-400">Flow of Funds</th>
                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-zinc-400">Corridors</th>
                    <th onClick={() => handleSort('volume')} className="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-zinc-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-800">
                      Total Volume <SortIcon columnKey="volume" />
                    </th>
                    <th onClick={() => handleSort('kybStatus')} className="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-zinc-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-800">
                      KYB Status <SortIcon columnKey="kybStatus" />
                    </th>
                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600 dark:text-zinc-400">Sumsub</th>
                    <th className="px-4 py-3 text-right text-sm font-semibold text-gray-600 dark:text-zinc-400">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {sortedClients.length === 0 ? (
                    <tr>
                      <td colSpan={9} className="px-4 py-20 text-center">
                        {clients.length === 0 ? (
                          <div className="flex flex-col items-center max-w-sm mx-auto">
                            <div className="relative mb-6">
                              <div className="w-24 h-24 bg-gradient-to-br from-blue-100 to-blue-100 rounded-2xl flex items-center justify-center rotate-3 shadow-lg">
                                <svg className="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                              </div>
                              <div className="absolute -bottom-2 -right-2 w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
                                </svg>
                              </div>
                            </div>
                            <h3 className="text-xl font-bold text-gray-800 mb-2">Welcome to SpherePay</h3>
                            <p className="text-slate-400 mb-6">Start building your pipeline by adding your first client</p>
                            <button onClick={() => { setEditingClient(null); setShowModal(true); }} className="btn-primary px-6 py-3 text-white rounded-xl font-semibold flex items-center gap-2">
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" /></svg>
                              Add Your First Client
                            </button>
                            <p className="text-xs text-slate-300 mt-4">Pro tip: Press <kbd className="px-1.5 py-0.5 bg-gray-100 rounded text-gray-600 font-mono">Ctrl+N</kbd> to quickly add clients</p>
                          </div>
                        ) : (
                          <div className="flex flex-col items-center max-w-sm mx-auto">
                            <div className="w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center mb-4 shadow-inner">
                              <svg className="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                              </svg>
                            </div>
                            <h3 className="text-lg font-semibold text-gray-700 mb-1">No results found</h3>
                            <p className="text-slate-400 mb-4">Try adjusting your search or filters</p>
                            <button onClick={() => { setSearch(''); setFilters({ kybStatus: '', type: '', priority: '' }); setActiveStatFilter(null); }} className="text-slate-600 hover:text-slate-800 font-medium flex items-center gap-1">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                              Clear all filters
                            </button>
                          </div>
                        )}
                      </td>
                    </tr>
                  ) : clientsGroupedView ? (
                    /* Grouped View - Aggregators with nested Sub-merchants */
                    (() => {
                      const aggregators = sortedClients.filter(c => c.type === 'Aggregator');
                      const standaloneSubMerchants = sortedClients.filter(c => c.type === 'Sub-merchant' && !c.parentAggregatorId);
                      const rows = [];

                      // Render each aggregator with its sub-merchants
                      aggregators.forEach(aggregator => {
                        const subMerchants = clients.filter(c => c.parentAggregatorId === aggregator.id);
                        const isExpanded = expandedAggregators.has(aggregator.id);
                        const aggregatorVolume = subMerchants.reduce((sum, sm) => sum + sm.corridors.reduce((s, c) => s + (c.expectedVolume || 0), 0), 0);

                        // Aggregator row (parent)
                        rows.push(
                          <tr key={aggregator.id} className={`bg-gradient-to-r from-blue-50 to-slate-50 hover:from-blue-100 hover:to-slate-100 transition-colors cursor-pointer border-l-4 border-l-blue-500 ${selectedClients.includes(aggregator.id) ? 'ring-2 ring-blue-300' : ''}`} onClick={() => setSelectedClient(aggregator)} onContextMenu={(e) => handleContextMenu(e, aggregator)}>
                            <td className="px-3 py-3" onClick={(e) => e.stopPropagation()}>
                              <div className="flex items-center gap-2">
                                <input type="checkbox" checked={selectedClients.includes(aggregator.id)} onChange={() => toggleClientSelection(aggregator.id)} className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                {subMerchants.length > 0 && (
                                  <button onClick={(e) => { e.stopPropagation(); toggleAggregatorExpanded(aggregator.id); }} className="p-0.5 hover:bg-blue-200 rounded transition-colors">
                                    <svg className={`w-4 h-4 text-blue-600 transition-transform ${isExpanded ? 'rotate-90' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                    </svg>
                                  </button>
                                )}
                              </div>
                            </td>
                            <td className="px-4 py-3">
                              <button onClick={(e) => { e.stopPropagation(); setNetworkViewAggregator(aggregator); }} className="font-semibold text-blue-800 hover:text-blue-600 transition-colors text-left flex items-center gap-2 group">
                                {pinnedClients.includes(aggregator.id) && <span className="text-amber-400">‚≠ê</span>}
                                <span className="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded text-xs font-medium">AGG</span>
                                {aggregator.name}
                                <svg className="w-4 h-4 text-blue-400 group-hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                              </button>
                              {subMerchants.length > 0 && <div className="text-xs text-blue-600 mt-0.5 font-medium">{subMerchants.length} sub-merchant{subMerchants.length !== 1 ? 's' : ''}</div>}
                            </td>
                            <td className="px-4 py-3"><span className="text-blue-700 font-medium">Aggregator</span></td>
                            <td className="px-4 py-3"><span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${aggregator.inFlowOfFunds ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>{aggregator.inFlowOfFunds ? 'Yes' : 'No'}</span></td>
                            <td className="px-4 py-3"><div className="flex flex-wrap gap-1">{aggregator.corridors.map(cor => (<span key={cor.id} className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs ${PRIORITY_COLORS[cor.priority].bg} ${PRIORITY_COLORS[cor.priority].text}`}>{cor.currency}</span>))}</div></td>
                            <td className="px-4 py-3 font-mono text-blue-700 font-semibold">{formatVolume(aggregatorVolume)}</td>
                            <td className="px-4 py-3"><span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${KYB_COLORS[aggregator.kybStatus].bg} ${KYB_COLORS[aggregator.kybStatus].text} border ${KYB_COLORS[aggregator.kybStatus].border}`}>{aggregator.kybStatus}</span></td>
                            <td className="px-4 py-3">{aggregator.sumsubLink ? (<a href={aggregator.sumsubLink} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="text-blue-600 hover:underline text-sm">View Link</a>) : (<span className="text-slate-300 text-sm">‚Äî</span>)}</td>
                            <td className="px-4 py-3"><div className="flex justify-end gap-2"><button onClick={(e) => { e.stopPropagation(); setEditingClient(aggregator); setShowModal(true); }} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-100 rounded transition-colors" title="Edit"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button><button onClick={(e) => { e.stopPropagation(); setDeleteTarget(aggregator); }} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td>
                          </tr>
                        );

                        // Sub-merchant rows (children) - only if expanded
                        if (isExpanded) {
                          subMerchants.forEach(subMerchant => {
                            const smVolume = subMerchant.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0);
                            rows.push(
                              <tr key={subMerchant.id} className={`bg-white hover:bg-gray-50 transition-colors cursor-pointer border-l-4 border-l-gray-200 ${selectedClients.includes(subMerchant.id) ? 'bg-blue-50' : ''}`} onClick={() => setSelectedClient(subMerchant)} onContextMenu={(e) => handleContextMenu(e, subMerchant)}>
                                <td className="px-3 py-2 pl-10" onClick={(e) => e.stopPropagation()}><input type="checkbox" checked={selectedClients.includes(subMerchant.id)} onChange={() => toggleClientSelection(subMerchant.id)} className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" /></td>
                                <td className="px-4 py-2 pl-8">
                                  <div className="flex items-center gap-2">
                                    <span className="text-gray-300">‚îî</span>
                                    <div className="font-medium text-gray-700 flex items-center gap-1.5">{pinnedClients.includes(subMerchant.id) && <span className="text-amber-400">‚≠ê</span>}<InlineEdit value={subMerchant.name} onSave={(newValue) => handleInlineEdit(subMerchant.id, 'name', newValue)} className="font-medium" /></div>
                                  </div>
                                </td>
                                <td className="px-4 py-2"><span className="text-slate-400 text-sm">Sub-merchant</span></td>
                                <td className="px-4 py-2"><span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${subMerchant.inFlowOfFunds ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>{subMerchant.inFlowOfFunds ? 'Yes' : 'No'}</span></td>
                                <td className="px-4 py-2"><div className="flex flex-wrap gap-1">{subMerchant.corridors.map(cor => (<span key={cor.id} className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs ${PRIORITY_COLORS[cor.priority].bg} ${PRIORITY_COLORS[cor.priority].text}`}>{cor.currency}</span>))}</div></td>
                                <td className="px-4 py-2 font-mono text-gray-600">{formatVolume(smVolume)}</td>
                                <td className="px-4 py-2"><span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${KYB_COLORS[subMerchant.kybStatus].bg} ${KYB_COLORS[subMerchant.kybStatus].text} border ${KYB_COLORS[subMerchant.kybStatus].border}`}>{subMerchant.kybStatus}</span></td>
                                <td className="px-4 py-2">{subMerchant.sumsubLink ? (<a href={subMerchant.sumsubLink} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="text-blue-600 hover:underline text-sm">View Link</a>) : (<span className="text-slate-300 text-sm">‚Äî</span>)}</td>
                                <td className="px-4 py-2"><div className="flex justify-end gap-2"><button onClick={(e) => { e.stopPropagation(); setEditingClient(subMerchant); setShowModal(true); }} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-gray-100 rounded transition-colors" title="Edit"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button><button onClick={(e) => { e.stopPropagation(); setDeleteTarget(subMerchant); }} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td>
                              </tr>
                            );
                          });
                        }
                      });

                      // Standalone sub-merchants (no parent)
                      if (standaloneSubMerchants.length > 0) {
                        rows.push(
                          <tr key="standalone-header" className="bg-gray-100">
                            <td colSpan={9} className="px-4 py-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Standalone Sub-merchants ({standaloneSubMerchants.length})</td>
                          </tr>
                        );
                        standaloneSubMerchants.forEach(sm => {
                          const smVolume = sm.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0);
                          rows.push(
                            <tr key={sm.id} className={`bg-white hover:bg-gray-50 transition-colors cursor-pointer ${selectedClients.includes(sm.id) ? 'bg-blue-50' : ''}`} onClick={() => setSelectedClient(sm)} onContextMenu={(e) => handleContextMenu(e, sm)}>
                              <td className="px-3 py-3" onClick={(e) => e.stopPropagation()}><input type="checkbox" checked={selectedClients.includes(sm.id)} onChange={() => toggleClientSelection(sm.id)} className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" /></td>
                              <td className="px-4 py-3"><div className="font-medium text-gray-800 flex items-center gap-1.5">{pinnedClients.includes(sm.id) && <span className="text-amber-400">‚≠ê</span>}<InlineEdit value={sm.name} onSave={(newValue) => handleInlineEdit(sm.id, 'name', newValue)} className="font-medium" /></div></td>
                              <td className="px-4 py-3"><span className="text-slate-400">Sub-merchant</span></td>
                              <td className="px-4 py-3"><span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${sm.inFlowOfFunds ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>{sm.inFlowOfFunds ? 'Yes' : 'No'}</span></td>
                              <td className="px-4 py-3"><div className="flex flex-wrap gap-1">{sm.corridors.map(cor => (<span key={cor.id} className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs ${PRIORITY_COLORS[cor.priority].bg} ${PRIORITY_COLORS[cor.priority].text}`}>{cor.currency}</span>))}</div></td>
                              <td className="px-4 py-3 font-mono text-gray-700">{formatVolume(smVolume)}</td>
                              <td className="px-4 py-3"><span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${KYB_COLORS[sm.kybStatus].bg} ${KYB_COLORS[sm.kybStatus].text} border ${KYB_COLORS[sm.kybStatus].border}`}>{sm.kybStatus}</span></td>
                              <td className="px-4 py-3">{sm.sumsubLink ? (<a href={sm.sumsubLink} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="text-blue-600 hover:underline text-sm">View Link</a>) : (<span className="text-slate-300 text-sm">‚Äî</span>)}</td>
                              <td className="px-4 py-3"><div className="flex justify-end gap-2"><button onClick={(e) => { e.stopPropagation(); setEditingClient(sm); setShowModal(true); }} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-gray-100 rounded transition-colors" title="Edit"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button><button onClick={(e) => { e.stopPropagation(); setDeleteTarget(sm); }} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td>
                            </tr>
                          );
                        });
                      }

                      return rows;
                    })()
                  ) : (
                    /* Flat View - Original rendering */
                    sortedClients.map(client => {
                      const parentAggregator = client.parentAggregatorId ? clients.find(c => c.id === client.parentAggregatorId) : null;
                      const subMerchantCount = client.type === 'Aggregator' ? clients.filter(c => c.parentAggregatorId === client.id).length : 0;
                      return (
                      <tr key={client.id} className={`hover:bg-blue-50/50 transition-colors cursor-pointer ${selectedClients.includes(client.id) ? 'bg-blue-50' : ''}`} onClick={() => setSelectedClient(client)} onContextMenu={(e) => handleContextMenu(e, client)}>
                        <td className="px-3 py-3" onClick={(e) => e.stopPropagation()}>
                          <input
                            type="checkbox"
                            checked={selectedClients.includes(client.id)}
                            onChange={() => toggleClientSelection(client.id)}
                            className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-cyan-500"
                          />
                        </td>
                        <td className="px-4 py-3">
                          {client.type === 'Aggregator' ? (
                            <button
                              onClick={(e) => { e.stopPropagation(); setNetworkViewAggregator(client); }}
                              className="font-medium text-gray-800 hover:text-blue-600 transition-colors text-left flex items-center gap-1.5 group"
                            >
                              {pinnedClients.includes(client.id) && <span className="text-amber-400">‚≠ê</span>}
                              {client.name}
                              <svg className="w-4 h-4 text-slate-300 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                              </svg>
                            </button>
                          ) : (
                            <div className="font-medium text-gray-800 flex items-center gap-1.5">
                              {pinnedClients.includes(client.id) && (
                                <span className="text-amber-400" title="Pinned">‚≠ê</span>
                              )}
                              <InlineEdit
                                value={client.name}
                                onSave={(newValue) => handleInlineEdit(client.id, 'name', newValue)}
                                className="font-medium"
                              />
                            </div>
                          )}
                          {parentAggregator && (
                            <button
                              onClick={(e) => { e.stopPropagation(); setNetworkViewAggregator(parentAggregator); }}
                              className="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1 mt-0.5 transition-colors"
                            >
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                              </svg>
                              {parentAggregator.name}
                            </button>
                          )}
                          {client.notes && <div className="text-xs text-slate-300 truncate max-w-[200px]">{client.notes}</div>}
                          {client.tags && client.tags.length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-1">
                              {client.tags.slice(0, 3).map((tag, i) => (
                                <span key={i} className="text-xs px-1.5 py-0.5 bg-blue-50 text-blue-700 rounded-full">{tag}</span>
                              ))}
                              {client.tags.length > 3 && (
                                <span className="text-xs px-1.5 py-0.5 bg-gray-100 text-slate-400 rounded-full">+{client.tags.length - 3}</span>
                              )}
                            </div>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          <div className="text-gray-600">{client.type}</div>
                          {subMerchantCount > 0 && (
                            <button
                              onClick={(e) => { e.stopPropagation(); setNetworkViewAggregator(client); }}
                              className="text-xs text-blue-600 font-medium hover:text-blue-700 transition-colors"
                            >
                              {subMerchantCount} sub-merchant{subMerchantCount !== 1 ? 's' : ''} ‚Üí
                            </button>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${client.inFlowOfFunds ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                            {client.inFlowOfFunds ? 'Yes' : 'No'}
                          </span>
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex flex-wrap gap-1">
                            {client.corridors.map(cor => (
                              <span key={cor.id} className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs ${PRIORITY_COLORS[cor.priority].bg} ${PRIORITY_COLORS[cor.priority].text}`}>
                                {cor.currency}
                              </span>
                            ))}
                          </div>
                        </td>
                        <td className="px-4 py-3 font-mono text-gray-700">
                          {formatVolume(client.type === 'Aggregator' ? clients.filter(c => c.parentAggregatorId === client.id).reduce((sum, sm) => sum + sm.corridors.reduce((s, c) => s + (c.expectedVolume || 0), 0), 0) : client.corridors.reduce((sum, c) => sum + (c.expectedVolume || 0), 0))}
                        </td>
                        <td className="px-4 py-3">
                          <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${KYB_COLORS[client.kybStatus].bg} ${KYB_COLORS[client.kybStatus].text} border ${KYB_COLORS[client.kybStatus].border}`}>
                            {client.kybStatus}
                          </span>
                        </td>
                        <td className="px-4 py-3">
                          {client.sumsubLink ? (
                            <a href={client.sumsubLink} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="text-blue-600 hover:text-blue-700 hover:underline text-sm">
                              View Link
                            </a>
                          ) : (
                            <span className="text-slate-300 text-sm">‚Äî</span>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex justify-end gap-2">
                            <button
                              onClick={(e) => { e.stopPropagation(); setEditingClient(client); setShowModal(true); }}
                              className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-gray-50 rounded transition-colors"
                              title="Edit"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                              </svg>
                            </button>
                            <button
                              onClick={(e) => { e.stopPropagation(); setDeleteTarget(client); }}
                              className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                              title="Delete"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            </button>
                          </div>
                        </td>
                      </tr>
                    )})
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Referrals View */}
        {viewMode === 'referrals' && (
          <div className="bg-white rounded-xl shadow-sm border animate-fade-in">
            <div className="p-4 border-b flex flex-wrap gap-4 items-center">
              <div className="flex-1 min-w-[200px]">
                <div className="relative">
                  <svg className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <input
                    type="text"
                    value={referralSearch}
                    onChange={(e) => setReferralSearch(e.target.value)}
                    placeholder="Search by company or referrer..."
                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                  />
                </div>
              </div>
              <select
                value={referralFilters.status}
                onChange={(e) => setReferralFilters({ ...referralFilters, status: e.target.value })}
                className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              >
                <option value="">All Status</option>
                {REFERRAL_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
              </select>
              <select
                value={referralFilters.referrerId}
                onChange={(e) => setReferralFilters({ ...referralFilters, referrerId: e.target.value })}
                className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              >
                <option value="">All Referrers</option>
                {referrers.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
              </select>
              {/* Grouped View Toggle for Referrals */}
              <button
                onClick={() => setReferralsGroupedView(!referralsGroupedView)}
                className={`px-3 py-2 border rounded-lg transition-colors flex items-center gap-2 ${referralsGroupedView ? 'bg-purple-50 border-purple-300 text-purple-700' : 'border-gray-300 hover:bg-gray-50 text-gray-700'}`}
                title={referralsGroupedView ? "Switch to flat view" : "Group by Referrer"}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                {referralsGroupedView ? 'Grouped' : 'Group'}
              </button>
              <button onClick={exportReferralsToCSV} className="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2 text-gray-700">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Export
              </button>
            </div>

            {/* Bulk Actions Bar */}
            {selectedReferrals.length > 0 && (
              <div className="px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 flex items-center justify-between">
                <div className="flex items-center gap-3 text-white">
                  <span className="font-semibold">{selectedReferrals.length} selected</span>
                  <button
                    onClick={() => setSelectedReferrals([])}
                    className="text-purple-100 hover:text-white text-sm underline"
                  >
                    Clear selection
                  </button>
                </div>
                <div className="flex items-center gap-2">
                  <select
                    onChange={(e) => { if (e.target.value) { handleBulkReferralStatusChange(e.target.value); e.target.value = ''; } }}
                    className="px-3 py-1.5 rounded-lg text-sm bg-white/20 text-white border border-white/30 focus:outline-none"
                  >
                    <option value="">Change Status...</option>
                    {REFERRAL_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                  <button
                    onClick={handleBulkDeleteReferrals}
                    className="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium flex items-center gap-1"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                  </button>
                </div>
              </div>
            )}

            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-3 py-3 text-left">
                      <input
                        type="checkbox"
                        checked={selectedReferrals.length === sortedReferrals.length && sortedReferrals.length > 0}
                        onChange={toggleSelectAllReferrals}
                        className="w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                      />
                    </th>
                    <th onClick={() => handleReferralSort('referredCompany')} className="px-4 py-3 text-left text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-100">
                      New Client (Referred) <ReferralSortIcon columnKey="referredCompany" />
                    </th>
                    <th onClick={() => handleReferralSort('referrer')} className="px-4 py-3 text-left text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-100">
                      Brought By (Referrer) <ReferralSortIcon columnKey="referrer" />
                    </th>
                    <th onClick={() => handleReferralSort('status')} className="px-4 py-3 text-left text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-100">
                      Status <ReferralSortIcon columnKey="status" />
                    </th>
                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Currencies & Cost %</th>
                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Fee Split</th>
                    <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {sortedReferrals.length === 0 ? (
                    <tr>
                      <td colSpan={7} className="px-4 py-16 text-center">
                        {referrals.length === 0 ? (
                          <div className="flex flex-col items-center">
                            <div className="w-20 h-20 bg-gradient-to-br from-purple-100 to-purple-200 rounded-full flex items-center justify-center mb-4">
                              <svg className="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                              </svg>
                            </div>
                            <h3 className="text-lg font-semibold text-gray-800 mb-1">No referrals yet</h3>
                            <p className="text-slate-400 mb-4">Add a partner first, then track clients they bring in</p>
                            <div className="flex gap-3">
                              <button onClick={() => { setEditingReferrer(null); setShowReferrerModal(true); }} className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">Add Partner</button>
                              <button onClick={() => { setEditingReferral(null); setShowReferralModal(true); }} className="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors">Add Referral</button>
                            </div>
                          </div>
                        ) : (
                          <div className="flex flex-col items-center">
                            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                              <svg className="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                              </svg>
                            </div>
                            <h3 className="text-lg font-medium text-gray-700 mb-1">No matching referrals</h3>
                            <p className="text-slate-400">Try adjusting your search or filters</p>
                          </div>
                        )}
                      </td>
                    </tr>
                  ) : referralsGroupedView ? (
                    /* Grouped View - Referrers with nested Referrals */
                    (() => {
                      const rows = [];
                      const referrersWithReferrals = referrers.filter(r => referrals.some(ref => ref.referrerId === r.id));
                      const orphanReferrals = sortedReferrals.filter(r => !r.referrerId || !referrers.find(ref => ref.id === r.referrerId));

                      // Render each referrer with their referrals
                      referrersWithReferrals.forEach(referrer => {
                        const referrerReferrals = sortedReferrals.filter(r => r.referrerId === referrer.id);
                        const isExpanded = expandedReferrers.has(referrer.id);
                        const activeCount = referrerReferrals.filter(r => r.status === 'Active').length;

                        // Referrer row (parent)
                        rows.push(
                          <tr key={`referrer-${referrer.id}`} className={`bg-gradient-to-r from-purple-50 to-slate-50 hover:from-purple-100 hover:to-slate-100 transition-colors cursor-pointer border-l-4 border-l-purple-500`}>
                            <td className="px-3 py-3" onClick={(e) => e.stopPropagation()}>
                              <div className="flex items-center gap-2">
                                <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 opacity-50" disabled />
                                {referrerReferrals.length > 0 && (
                                  <button onClick={(e) => { e.stopPropagation(); toggleReferrerExpanded(referrer.id); }} className="p-0.5 hover:bg-purple-200 rounded transition-colors">
                                    <svg className={`w-4 h-4 text-purple-600 transition-transform ${isExpanded ? 'rotate-90' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                    </svg>
                                  </button>
                                )}
                              </div>
                            </td>
                            <td className="px-4 py-3">
                              <button onClick={() => setNetworkViewReferrer(referrer)} className="font-semibold text-purple-800 hover:text-purple-600 transition-colors text-left flex items-center gap-2 group">
                                <span className="bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded text-xs font-medium">PARTNER</span>
                                {referrer.name}
                                <svg className="w-4 h-4 text-purple-400 group-hover:text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                              </button>
                              <div className="text-xs text-purple-600 mt-0.5 font-medium">{referrerReferrals.length} referral{referrerReferrals.length !== 1 ? 's' : ''} ‚Ä¢ {activeCount} active</div>
                            </td>
                            <td className="px-4 py-3"><span className="text-purple-700 font-medium">{referrer.type}</span></td>
                            <td className="px-4 py-3">
                              <div className="flex gap-1">
                                <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">{activeCount} Active</span>
                                {referrerReferrals.length - activeCount > 0 && <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">{referrerReferrals.length - activeCount} Other</span>}
                              </div>
                            </td>
                            <td className="px-4 py-3"><span className="text-slate-300 text-sm">‚Äî</span></td>
                            <td className="px-4 py-3">
                              {referrer.feeSplitPercentage > 0 ? (
                                <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200">
                                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                  <span className="font-mono">{referrer.feeSplitPercentage}%</span>
                                </span>
                              ) : (<span className="text-slate-300 text-sm">Not set</span>)}
                            </td>
                            <td className="px-4 py-3">
                              <div className="flex justify-end gap-2">
                                <button onClick={() => { setEditingReferrer(referrer); setShowReferrerModal(true); }} className="p-1.5 text-slate-400 hover:text-purple-600 hover:bg-purple-100 rounded transition-colors" title="Edit Partner"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                              </div>
                            </td>
                          </tr>
                        );

                        // Referral rows (children) - only if expanded
                        if (isExpanded) {
                          referrerReferrals.forEach(referral => {
                            rows.push(
                              <tr key={referral.id} className={`bg-white hover:bg-gray-50 transition-colors cursor-pointer border-l-4 border-l-gray-200 ${selectedReferrals.includes(referral.id) ? 'bg-purple-50' : ''}`} onContextMenu={(e) => handleReferralContextMenu(e, referral)}>
                                <td className="px-3 py-2 pl-10" onClick={(e) => e.stopPropagation()}><input type="checkbox" checked={selectedReferrals.includes(referral.id)} onChange={() => toggleReferralSelection(referral.id)} className="w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500" /></td>
                                <td className="px-4 py-2 pl-8">
                                  <div className="flex items-center gap-2">
                                    <span className="text-gray-300">‚îî</span>
                                    <div className="font-medium text-gray-700">{referral.referredCompany}</div>
                                  </div>
                                  {referral.notes && <div className="text-xs text-slate-300 truncate max-w-[200px] ml-5">{referral.notes}</div>}
                                </td>
                                <td className="px-4 py-2"><span className="text-slate-400 text-sm">Referred Client</span></td>
                                <td className="px-4 py-2"><span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${REFERRAL_STATUS_COLORS[referral.status].bg} ${REFERRAL_STATUS_COLORS[referral.status].text} border ${REFERRAL_STATUS_COLORS[referral.status].border}`}>{referral.status}</span></td>
                                <td className="px-4 py-2"><div className="flex flex-wrap gap-1">{referral.currencies.map(curr => (<span key={curr.id} className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">{curr.currency}: <span className="font-mono">{curr.costPercentage}%</span></span>))}</div></td>
                                <td className="px-4 py-2"><span className="text-slate-300 text-sm">‚Äî</span></td>
                                <td className="px-4 py-2"><div className="flex justify-end gap-2"><button onClick={() => { setEditingReferral(referral); setShowReferralModal(true); }} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-gray-100 rounded transition-colors" title="Edit"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button><button onClick={() => setDeleteReferralTarget(referral)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td>
                              </tr>
                            );
                          });
                        }
                      });

                      // Orphan referrals (no referrer)
                      if (orphanReferrals.length > 0) {
                        rows.push(
                          <tr key="orphan-header" className="bg-gray-100">
                            <td colSpan={7} className="px-4 py-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Unassigned Referrals ({orphanReferrals.length})</td>
                          </tr>
                        );
                        orphanReferrals.forEach(referral => {
                          rows.push(
                            <tr key={referral.id} className={`bg-white hover:bg-gray-50 transition-colors cursor-pointer ${selectedReferrals.includes(referral.id) ? 'bg-purple-50' : ''}`} onContextMenu={(e) => handleReferralContextMenu(e, referral)}>
                              <td className="px-3 py-3" onClick={(e) => e.stopPropagation()}><input type="checkbox" checked={selectedReferrals.includes(referral.id)} onChange={() => toggleReferralSelection(referral.id)} className="w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500" /></td>
                              <td className="px-4 py-3"><div className="font-medium text-gray-800">{referral.referredCompany}</div>{referral.notes && <div className="text-xs text-slate-300 truncate max-w-[200px]">{referral.notes}</div>}</td>
                              <td className="px-4 py-3"><span className="text-slate-300">No referrer</span></td>
                              <td className="px-4 py-3"><span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${REFERRAL_STATUS_COLORS[referral.status].bg} ${REFERRAL_STATUS_COLORS[referral.status].text} border ${REFERRAL_STATUS_COLORS[referral.status].border}`}>{referral.status}</span></td>
                              <td className="px-4 py-3"><div className="flex flex-wrap gap-1">{referral.currencies.map(curr => (<span key={curr.id} className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">{curr.currency}: <span className="font-mono">{curr.costPercentage}%</span></span>))}</div></td>
                              <td className="px-4 py-3"><span className="text-slate-300 text-sm">‚Äî</span></td>
                              <td className="px-4 py-3"><div className="flex justify-end gap-2"><button onClick={() => { setEditingReferral(referral); setShowReferralModal(true); }} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-gray-100 rounded transition-colors" title="Edit"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button><button onClick={() => setDeleteReferralTarget(referral)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td>
                            </tr>
                          );
                        });
                      }

                      return rows;
                    })()
                  ) : (
                    /* Flat View - Original rendering */
                    sortedReferrals.map(referral => {
                      const referrer = referrers.find(r => r.id === referral.referrerId);
                      const referrerReferralCount = referrals.filter(r => r.referrerId === referral.referrerId).length;
                      return (
                        <tr key={referral.id} className={`hover:bg-gray-50/50 transition-colors cursor-pointer ${selectedReferrals.includes(referral.id) ? 'bg-gray-50' : ''}`} onContextMenu={(e) => handleReferralContextMenu(e, referral)}>
                          <td className="px-3 py-3" onClick={(e) => e.stopPropagation()}>
                            <input
                              type="checkbox"
                              checked={selectedReferrals.includes(referral.id)}
                              onChange={() => toggleReferralSelection(referral.id)}
                              className="w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                            />
                          </td>
                          <td className="px-4 py-3">
                            <div className="font-medium text-gray-800">{referral.referredCompany}</div>
                            {referral.notes && <div className="text-xs text-slate-300 truncate max-w-[200px]">{referral.notes}</div>}
                          </td>
                          <td className="px-4 py-3">
                            {referrer ? (
                              <button
                                onClick={() => setNetworkViewReferrer(referrer)}
                                className="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1 transition-colors"
                              >
                                {referrer.name}
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                              </button>
                            ) : (
                              <span className="text-slate-300">Unknown</span>
                            )}
                            <div className="text-xs text-slate-400">{referrer?.type} ‚Ä¢ {referrerReferralCount} referral{referrerReferralCount !== 1 ? 's' : ''}</div>
                          </td>
                          <td className="px-4 py-3">
                            <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${REFERRAL_STATUS_COLORS[referral.status].bg} ${REFERRAL_STATUS_COLORS[referral.status].text} border ${REFERRAL_STATUS_COLORS[referral.status].border}`}>
                              {referral.status}
                            </span>
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex flex-wrap gap-1">
                              {referral.currencies.map(curr => (
                                <span key={curr.id} className="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">
                                  {curr.currency}: <span className="font-mono">{curr.costPercentage}%</span>
                                </span>
                              ))}
                            </div>
                          </td>
                          <td className="px-4 py-3">
                            {referrer?.feeSplitPercentage > 0 ? (
                              <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span className="font-mono">{referrer.feeSplitPercentage}%</span>
                              </span>
                            ) : (
                              <span className="text-slate-300 text-sm">Not set</span>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex justify-end gap-2">
                              <button
                                onClick={() => { setEditingReferral(referral); setShowReferralModal(true); }}
                                className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-gray-50 rounded transition-colors"
                                title="Edit"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                              </button>
                              <button
                                onClick={() => setDeleteReferralTarget(referral)}
                                className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                title="Delete"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                              </button>
                            </div>
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </main>

      <Modal
        isOpen={showModal}
        onClose={() => { setShowModal(false); setEditingClient(null); }}
        title={editingClient ? 'Edit Client' : 'Add New Client'}
      >
        <ClientForm
          client={editingClient}
          onSave={handleSave}
          onClose={() => { setShowModal(false); setEditingClient(null); }}
          allClients={clients}
        />
      </Modal>

      <DeleteModal
        isOpen={!!deleteTarget}
        onClose={() => setDeleteTarget(null)}
        onConfirm={handleDelete}
        clientName={deleteTarget?.name}
      />

      <NetworkModal
        isOpen={!!networkViewAggregator}
        onClose={() => setNetworkViewAggregator(null)}
        aggregator={networkViewAggregator}
        subMerchants={networkViewAggregator ? getSubMerchants(networkViewAggregator.id) : []}
      />

      {/* Referrer Modal */}
      <Modal
        isOpen={showReferrerModal}
        onClose={() => { setShowReferrerModal(false); setEditingReferrer(null); }}
        title={editingReferrer ? 'Edit Referrer' : 'Add Partner (Who brings clients)'}
      >
        <ReferrerForm
          referrer={editingReferrer}
          onSave={handleSaveReferrer}
          onClose={() => { setShowReferrerModal(false); setEditingReferrer(null); }}
        />
      </Modal>

      {/* Referral Modal */}
      <Modal
        isOpen={showReferralModal}
        onClose={() => { setShowReferralModal(false); setEditingReferral(null); }}
        title={editingReferral ? 'Edit Referral' : 'Add New Client (Referral)'}
      >
        <ReferralForm
          referral={editingReferral}
          onSave={handleSaveReferral}
          onClose={() => { setShowReferralModal(false); setEditingReferral(null); }}
          allReferrers={referrers}
        />
      </Modal>

      {/* Delete Referrer Modal */}
      <DeleteModal
        isOpen={!!deleteReferrerTarget}
        onClose={() => setDeleteReferrerTarget(null)}
        onConfirm={handleDeleteReferrer}
        clientName={deleteReferrerTarget?.name}
      />

      {/* Delete Referral Modal */}
      <DeleteModal
        isOpen={!!deleteReferralTarget}
        onClose={() => setDeleteReferralTarget(null)}
        onConfirm={handleDeleteReferral}
        clientName={deleteReferralTarget?.referredCompany}
      />

      {/* Referral Network Modal */}
      <ReferralNetworkModal
        isOpen={!!networkViewReferrer}
        onClose={() => setNetworkViewReferrer(null)}
        referrer={networkViewReferrer}
        referrals={networkViewReferrer ? getReferralsForReferrer(networkViewReferrer.id) : []}
      />

      {/* Client Detail Sidebar */}
      <ClientDetailSidebar
        client={selectedClient}
        onClose={() => setSelectedClient(null)}
        onEdit={(client) => { setEditingClient(client); setShowModal(true); }}
        onDelete={(client) => setDeleteTarget(client)}
        formatVolume={formatVolume}
      />

      {/* Command Palette */}
      <CommandPalette
        isOpen={showCommandPalette}
        onClose={() => setShowCommandPalette(false)}
        clients={clients}
        onSelectClient={(client) => setSelectedClient(client)}
        onAddClient={() => { setEditingClient(null); setShowModal(true); }}
        onNavigate={(view) => {
          if (view === 'analytics') { setShowDashboard(true); setShowKanban(false); setViewMode('clients'); }
          else if (view === 'clients') { setViewMode('clients'); setShowDashboard(false); setShowKanban(false); }
          else if (view === 'kanban') { setViewMode('clients'); setShowKanban(true); setShowDashboard(false); }
          else if (view === 'referrals') { setViewMode('referrals'); setShowDashboard(false); setShowKanban(false); }
          else if (view === 'partners') { setViewMode('partners'); setShowDashboard(false); setShowKanban(false); }
        }}
        onExport={exportToCSV}
      />

      {toast && (
        <Toast
          message={toast.message}
          type={toast.type}
          onClose={() => setToast(null)}
          onUndo={toast.type === 'undo' ? handleUndoDelete : null}
        />
      )}

      {/* Right-click Context Menu for Clients */}
      {contextMenu && (
        <ContextMenu
          x={contextMenu.x}
          y={contextMenu.y}
          client={contextMenu.client}
          onClose={() => setContextMenu(null)}
          onChangeStatus={handleUpdateKybStatus}
          onEdit={(client) => { setEditingClient(client); setShowModal(true); }}
          onDelete={(client) => setDeleteTarget(client)}
          onPin={togglePinClient}
          isPinned={pinnedClients.includes(contextMenu.client.id)}
        />
      )}

      {/* Bulk Confirm Modal */}
      {showBulkConfirm && (
        <BulkConfirmModal
          isOpen={true}
          onClose={() => setShowBulkConfirm(null)}
          onConfirm={() => {
            if (showBulkConfirm.action === 'deleteClients') handleBulkDelete();
            else if (showBulkConfirm.action === 'deleteReferrals') handleBulkDeleteReferrals();
            setShowBulkConfirm(null);
          }}
          action="delete"
          count={showBulkConfirm.count}
        />
      )}

      {/* Right-click Context Menu for Referrals */}
      {referralContextMenu && (
        <ReferralContextMenu
          x={referralContextMenu.x}
          y={referralContextMenu.y}
          referral={referralContextMenu.referral}
          onClose={() => setReferralContextMenu(null)}
          onChangeStatus={handleUpdateReferralStatus}
          onEdit={(referral) => { setEditingReferral(referral); setShowReferralModal(true); }}
          onDelete={(referral) => setDeleteReferralTarget(referral)}
        />
      )}
    </div>
  );
}

// Wrap App with AuthWrapper
function Root() {
  return (
    <AuthWrapper>
      {(user) => <App currentUser={user} />}
    </AuthWrapper>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
